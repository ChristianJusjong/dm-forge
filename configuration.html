<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Campaign Configuration - Dungeon Master Forge</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="design-system.css">
  <link rel="stylesheet" href="medieval-theme.css">
  <link rel="stylesheet" href="responsive-design.css">
  <link rel="stylesheet" href="global-overrides.css">
  <link rel="manifest" href="manifest.json">
</head>

<body>
  <div id="app">
    <!-- Navigation will be inserted here by nav.js -->

    <!-- Configuration Content -->
    <main class="page-content">
      <div class="page-header">
        <h1 class="page-title">‚öôÔ∏è Campaign Configuration</h1>
        <p class="page-subtitle">Manage your campaign, party, and sessions</p>
      </div>

      <!-- Tab Navigation -->
      <div class="card mb-xl p-0 overflow-hidden">
        <div class="config-tabs">
          <button class="config-tab active" data-tab="campaign">
            üìñ Campaign
          </button>
          <button class="config-tab" data-tab="party">
            üõ°Ô∏è Party
          </button>
          <button class="config-tab" data-tab="session">
            ‚öîÔ∏è Session
          </button>
        </div>
      </div>

      <!-- Campaign Tab -->
      <div id="tab-campaign" class="config-tab-content">
        <div class="card mb-xl">
          <h3 class="text-gold mb-lg">Campaign Information</h3>
          <div id="campaign-details"></div>
        </div>

        <!-- Language Settings -->
        <div class="card mb-xl">
          <h3 class="text-gold mb-lg">üåê Language Settings</h3>
          <div class="input-group">
            <label class="input-label">Interface Language</label>
            <select id="language-selector" class="input" style="max-width: 300px;">
              <option value="en">English</option>
              <option value="da">Danish (Dansk)</option>
            </select>
            <p class="text-muted text-sm mt-sm">
              This changes the language of buttons, menus, and labels throughout the app.
            </p>
          </div>
        </div>

        <!-- AI Settings -->
        <div class="card mb-xl">
          <h3 class="text-gold mb-lg">ü§ñ AI Settings</h3>
          <p class="text-primary mb-lg" style="line-height: 1.8;">
            Configure AI features like NPC generation, content creation, and translation.
          </p>

          <!-- Groq API Key -->
          <div class="input-group" style="margin-bottom: 1.5rem;">
            <label class="input-label">Groq API Key</label>
            <div style="display: flex; gap: 0.5rem; align-items: flex-start; flex-wrap: wrap;">
              <input id="groq-api-key" type="password" placeholder="Enter your Groq API key" class="input"
                style="flex: 1; min-width: 250px;">
              <button onclick="toggleApiKeyVisibility()" class="btn" style="padding: 0.75rem 1rem;">
                üëÅÔ∏è Show
              </button>
              <button onclick="saveApiKey()" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">
                üíæ Save
              </button>
            </div>
            <div id="api-key-status" style="margin-top: 0.5rem; font-size: 0.9rem;"></div>
          </div>

          <!-- Setup Guide -->
          <details
            style="background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212, 175, 55, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
            <summary style="color: #d4af37; cursor: pointer; font-weight: 600; margin-bottom: 0.5rem;">
              üìñ How to get a Groq API Key (Free)
            </summary>
            <div style="color: #e8d5b7; line-height: 1.8; padding-top: 1rem;">
              <ol style="margin-left: 1.5rem;">
                <li style="margin-bottom: 1rem;">
                  <strong>Visit Groq Console:</strong> Go to
                  <a href="https://console.groq.com" target="_blank" rel="noopener"
                    style="color: #f0d06b; text-decoration: underline;">
                    console.groq.com
                  </a>
                </li>
                <li style="margin-bottom: 1rem;">
                  <strong>Create Account:</strong> Sign up with Google, GitHub, or email (it's free!)
                </li>
                <li style="margin-bottom: 1rem;">
                  <strong>Generate API Key:</strong> Click on "API Keys" in the sidebar, then "Create API Key"
                </li>
                <li style="margin-bottom: 1rem;">
                  <strong>Copy & Paste:</strong> Copy your new API key and paste it in the field above
                </li>
                <li style="margin-bottom: 0.5rem;">
                  <strong>Save:</strong> Click the "Save" button to store your key securely in your campaign
                </li>
              </ol>
              <div
                style="background: rgba(139, 0, 0, 0.2); border: 1px solid rgba(139, 0, 0, 0.5); border-radius: 6px; padding: 1rem; margin-top: 1rem;">
                <strong style="color: #ff6b6b;">üîí Security Note:</strong>
                <p style="color: #e8d5b7; margin-top: 0.5rem; font-size: 0.9rem;">
                  Your API key is stored locally in your browser only. Never share your API key with anyone.
                  Groq offers generous free tier limits for personal use.
                </p>
              </div>
            </div>
          </details>

          <!-- Features List -->
          <div class="p-md" style="background: rgba(212, 175, 55, 0.05); border-radius: 8px;">
            <p class="text-muted text-sm mb-sm"><strong>AI Features:</strong></p>
            <ul class="text-primary text-sm" style="line-height: 1.8; margin-left: 1.5rem;">
              <li>Generate detailed NPCs with personalities and backstories</li>
              <li>Create encounter descriptions and scenarios</li>
              <li>Translate content to multiple languages</li>
              <li>Generate campaign ideas and plot hooks</li>
            </ul>
          </div>
        </div>

        <!-- Backup & Export -->
        <div class="card mb-xl">
          <h3 class="text-gold mb-lg">üíæ Backup & Export</h3>
          <p class="text-primary mb-lg" style="line-height: 1.8;">
            Export your campaign data, party, and session notes. Import backups to restore your data.
          </p>
          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="backup.html" class="btn btn-primary" style="text-decoration: none;">
              üíæ Open Backup Manager
            </a>
          </div>
        </div>
      </div>

      <!-- Party Tab -->
      <div id="tab-party" class="config-tab-content" style="display: none;">

        <!-- Party Summary Card -->
        <div class="card" style="margin-bottom: 2rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
            <div>
              <h3
                style="color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.6), 2px 2px 4px rgba(0, 0, 0, 0.9); margin-bottom: 0.5rem;">
                Party Overview</h3>
              <div style="display: flex; gap: 2rem; flex-wrap: wrap;">
                <div>
                  <span style="color: #e8d5b7; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Members:</span>
                  <strong id="party-count"
                    style="color: #f0d06b; font-size: 1.3rem; margin-left: 0.5rem; text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);">0</strong>
                </div>
                <div>
                  <span style="color: #e8d5b7; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">Average Level:</span>
                  <strong id="party-avg-level"
                    style="color: #f0d06b; font-size: 1.3rem; margin-left: 0.5rem; text-shadow: 0 0 8px rgba(212, 175, 55, 0.5);">-</strong>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button id="import-dndb-btn" class="btn btn-secondary">Import JSON</button>
              <button id="clear-party-btn" class="btn btn-danger">Clear All</button>
            </div>
          </div>
        </div>

        <!-- Add Character Form -->
        <div class="card" style="margin-bottom: 2rem;">
          <h3
            style="color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.6), 2px 2px 4px rgba(0, 0, 0, 0.9); margin-bottom: 1.5rem;">
            Add Party Member</h3>

          <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
            <div class="input-group">
              <label class="input-label">Character Name</label>
              <input id="char-name" type="text" placeholder="e.g., Thorin" class="input">
            </div>

            <div class="input-group">
              <label class="input-label">Class</label>
              <select id="char-class" class="input">
                <option value="">Select Class</option>
                <option value="Barbarian">Barbarian</option>
                <option value="Bard">Bard</option>
                <option value="Cleric">Cleric</option>
                <option value="Druid">Druid</option>
                <option value="Fighter">Fighter</option>
                <option value="Monk">Monk</option>
                <option value="Paladin">Paladin</option>
                <option value="Ranger">Ranger</option>
                <option value="Rogue">Rogue</option>
                <option value="Sorcerer">Sorcerer</option>
                <option value="Warlock">Warlock</option>
                <option value="Wizard">Wizard</option>
              </select>
            </div>

            <div class="input-group">
              <label class="input-label">Race</label>
              <select id="char-race" class="input">
                <option value="">Select Race</option>
                <option value="Human">Human</option>
                <option value="Elf">Elf</option>
                <option value="Dwarf">Dwarf</option>
                <option value="Halfling">Halfling</option>
                <option value="Dragonborn">Dragonborn</option>
                <option value="Gnome">Gnome</option>
                <option value="Half-Elf">Half-Elf</option>
                <option value="Half-Orc">Half-Orc</option>
                <option value="Tiefling">Tiefling</option>
              </select>
            </div>

            <div class="input-group">
              <label class="input-label">Level</label>
              <input id="char-level" type="number" min="1" max="20" value="1" class="input">
            </div>
          </div>

          <button id="add-character-btn" class="btn btn-large" style="width: 100%;">+ Add Character</button>
        </div>

        <!-- Party Members List -->
        <div id="party-list" class="cards-grid" style="grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));">
          <!-- Party members will be rendered here -->
        </div>

        <div id="no-party" class="empty-state" style="display: none;">
          <p>No party members yet. Add your first character above!</p>
        </div>

        <!-- Confirm Party Button -->
        <div id="confirm-party-section" style="display: none; text-align: center; margin: 2rem auto; max-width: 600px;">
          <div class="card"
            style="background: linear-gradient(135deg, rgba(212, 175, 55, 0.15) 0%, rgba(139, 0, 0, 0.15) 100%); border: 2px solid rgba(212, 175, 55, 0.6);">
            <h3 style="color: #d4af37; margin-bottom: 1rem;">‚úÖ Ready to Begin?</h3>
            <p style="color: #e8d5b7; line-height: 1.8; margin-bottom: 1.5rem;">
              Once you confirm your party, you can start your first session. You can always come back to adjust levels
              later.
            </p>
            <button id="confirm-party-btn" class="btn btn-primary" style="font-size: 1.1rem; padding: 0.75rem 2rem;">
              ‚öîÔ∏è Confirm Party & Continue
            </button>
          </div>
        </div>

        <!-- Quick Start Templates -->
        <div class="card" style="margin-top: 3rem;">
          <h3
            style="color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.6), 2px 2px 4px rgba(0, 0, 0, 0.9); margin-bottom: 1rem;">
            Quick Start Templates</h3>
          <p
            style="color: #e8d5b7; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); line-height: 1.7; margin-bottom: 1.5rem;">
            Pre-made party compositions to get started quickly</p>

          <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
            <button class="btn btn-secondary template-btn" data-template="classic">Classic Party (4)</button>
            <button class="btn btn-secondary template-btn" data-template="small">Small Party (3)</button>
            <button class="btn btn-secondary template-btn" data-template="large">Large Party (6)</button>
          </div>
        </div>
      </div>

      <!-- Session Tab -->
      <div id="tab-session" class="config-tab-content" style="display: none;">
        <div class="card" style="margin-bottom: 2rem;">
          <h3 style="color: #d4af37; margin-bottom: 1.5rem;">Session Management</h3>
          <div id="session-controls"></div>
        </div>

        <div class="card">
          <h3 style="color: #d4af37; margin-bottom: 1.5rem;">Session History</h3>
          <div id="session-history"></div>
        </div>
      </div>
    </main>
  </div>

  <!-- End Session Modal -->
  <div id="end-session-modal-config" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h2 style="color: #d4af37; margin-bottom: 1.5rem;">üìú End Session</h2>
      <p style="margin-bottom: 1.5rem; line-height: 1.8;">
        Save your session notes before ending.
      </p>
      <div class="input-group">
        <label class="input-label">Session Notes (Optional)</label>
        <textarea id="session-notes-textarea-config" class="textarea" rows="5"
          placeholder="What happened in this session?"></textarea>
      </div>
      <div class="modal-actions" style="margin-top: 2rem;">
        <button class="btn btn-primary" onclick="endSessionFromConfig()">
          üíæ End Session
        </button>
        <button class="btn" onclick="document.getElementById('end-session-modal-config').style.display='none'">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- D&D Beyond Import Modal -->
  <div id="import-dndb-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3>üì• Import from D&D Beyond</h3>
      <p class="text-muted mb-md">Import directly from D&D Beyond URL or paste JSON.</p>

      <div class="input-group mb-md">
        <label class="input-label">D&D Beyond URL (e.g., dndbeyond.com/.../12345)</label>
        <div style="display: flex; gap: 0.5rem;">
          <input type="text" id="dndb-url-input" class="input" placeholder="https://www.dndbeyond.com/characters/..." />
          <button id="fetch-dndb-btn" class="btn btn-primary">Fetch</button>
        </div>
        <p id="fetch-status" class="text-sm mt-sm" style="display:none;"></p>
      </div>

      <div style="text-align: center; margin: 1rem 0; color: var(--gold-dark);">- OR -</div>

      <textarea id="dndb-json-input" class="textarea" rows="5" placeholder='Paste JSON here...'></textarea>
      <div id="import-error" class="text-danger mb-md" style="display: none;"></div>
      <div class="modal-actions">
        <button id="process-import-btn" class="btn">Import Character</button>
        <button id="cancel-import-btn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <script src="ads.js"></script>
  <script src="storage-utils.js"></script>
  <script src="dndbeyond-parser.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="translations.js"></script>
  <script type="module" src="campaign-manager.js"></script>
  <script type="module" src="nav.js"></script>
  <script type="module" src="tutorial.js"></script>
  <script>
    // Wait for modules to load
    window.addEventListener('load', () => {
      // Require authentication
      if (typeof requireAuth === 'function' && !requireAuth()) {
        // User will be redirected to login
        throw new Error('Authentication required');
      }

      // Load saved API key
      loadApiKey();
    });

    // ========================================
    // API KEY MANAGEMENT
    // ========================================

    // Save API key to user profile
    function saveApiKey() {
      const apiKeyInput = document.getElementById('groq-api-key');
      const statusDiv = document.getElementById('api-key-status');
      const apiKey = apiKeyInput.value.trim();

      console.log('saveApiKey called with key:', apiKey ? 'key present' : 'no key');

      if (!apiKey) {
        statusDiv.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Please enter an API key</span>';
        return;
      }

      // Validate API key format (basic check)
      if (!apiKey.startsWith('gsk_')) {
        statusDiv.innerHTML = '<span style="color: #ff9800;">‚ö†Ô∏è Warning: Groq API keys usually start with "gsk_"</span>';
        // Don't return - let them save anyway in case format changed
      }

      // Check if auth functions are available
      if (typeof getCurrentUser !== 'function' || typeof saveUserApiKey !== 'function') {
        console.error('Auth functions not available:', {
          getCurrentUser: typeof getCurrentUser,
          saveUserApiKey: typeof saveUserApiKey
        });
        statusDiv.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Auth system not loaded. Please refresh the page.</span>';
        return;
      }

      // Get current user
      const currentUser = getCurrentUser();
      console.log('Current user:', currentUser ? currentUser.username : 'not logged in');

      if (!currentUser) {
        statusDiv.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è User not logged in</span>';
        return;
      }

      // Save API key to user profile
      const result = saveUserApiKey(currentUser.username, apiKey);
      console.log('Save result:', result);

      if (result.success) {
        statusDiv.innerHTML = '<span style="color: #4caf50;">‚úì API key saved to your profile!</span>';
        console.log('‚úÖ API key saved successfully');
      } else {
        statusDiv.innerHTML = '<span style="color: #ff6b6b;">‚ö†Ô∏è Failed to save API key: ' + (result.message || 'Unknown error') + '</span>';
        console.error('‚ùå Failed to save API key:', result);
      }

      // Clear status after 3 seconds
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 3000);
    }

    // Load API key from user profile
    function loadApiKey() {
      const currentUser = getCurrentUser();
      if (!currentUser) {
        return;
      }

      const apiKey = getUserApiKey(currentUser.username);
      if (apiKey) {
        const apiKeyInput = document.getElementById('groq-api-key');
        apiKeyInput.value = apiKey;
      }
    }

    // Toggle API key visibility
    function toggleApiKeyVisibility() {
      const apiKeyInput = document.getElementById('groq-api-key');
      const btn = event.target;

      if (apiKeyInput.type === 'password') {
        apiKeyInput.type = 'text';
        btn.textContent = 'üôà Hide';
      } else {
        apiKeyInput.type = 'password';
        btn.textContent = 'üëÅÔ∏è Show';
      }
    }

    // Note: getGroqApiKey is now defined in auth.js and available globally

    // ========================================
    // PARTY SETUP
    // ========================================

    let party = [];

    // Class icons
    const classIcons = {
      'Barbarian': '‚öîÔ∏è',
      'Bard': 'üéµ',
      'Cleric': '‚úùÔ∏è',
      'Druid': 'üåø',
      'Fighter': 'üõ°Ô∏è',
      'Monk': 'üëä',
      'Paladin': '‚öúÔ∏è',
      'Ranger': 'üèπ',
      'Rogue': 'üó°Ô∏è',
      'Sorcerer': '‚ú®',
      'Warlock': 'üîÆ',
      'Wizard': 'üßô'
    };

    function loadParty() {
      const saved = localStorage.getItem('party_members');
      if (saved) {
        party = JSON.parse(saved);
      }
    }

    function saveParty() {
      localStorage.setItem('party_members', JSON.stringify(party));

      // Save to campaign
      if (typeof updateParty === 'function') {
        updateParty(party);
      }

      updatePartyStats();
      renderParty();
      updateConfirmButton();
    }

    function updateConfirmButton() {
      const confirmSection = document.getElementById('confirm-party-section');
      const campaign = getActiveCampaign();

      // Show confirm button if party has members and not yet confirmed
      if (party.length > 0 && campaign && !campaign.partyConfirmed) {
        confirmSection.style.display = 'block';
      } else {
        confirmSection.style.display = 'none';
      }
    }

    function updatePartyStats() {
      document.getElementById('party-count').textContent = party.length;

      if (party.length > 0) {
        const avgLevel = party.reduce((sum, char) => sum + char.level, 0) / party.length;
        document.getElementById('party-avg-level').textContent = avgLevel.toFixed(1);
      } else {
        document.getElementById('party-avg-level').textContent = '-';
      }
    }

    function renderParty() {
      const list = document.getElementById('party-list');
      const noParty = document.getElementById('no-party');

      if (party.length === 0) {
        list.innerHTML = '';
        noParty.style.display = 'block';
        return;
      }

      noParty.style.display = 'none';

      list.innerHTML = party.map((char, index) => `
        <div class="card" style="position: relative;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
            <div>
              <div style="font-size: 2.5rem; margin-bottom: 0.5rem; filter: drop-shadow(0 0 8px rgba(212, 175, 55, 0.3));">${classIcons[char.class] || '‚öîÔ∏è'}</div>
              <h3 style="color: #d4af37; text-shadow: 0 0 10px rgba(212, 175, 55, 0.6), 2px 2px 4px rgba(0, 0, 0, 0.9); margin-bottom: 0.25rem;">${escapeHTML(char.name)}</h3>
              <p style="color: #e8d5b7; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); font-size: 0.95rem; line-height: 1.5;">${char.race} ${char.class}</p>
            </div>
            <button class="btn-small btn-danger remove-character" data-index="${index}">√ó</button>
          </div>

          <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(212, 175, 55, 0.1); border-radius: 6px; border: 1px solid rgba(124, 98, 77, 0.3);">
            <span style="color: #e8d5b7; text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8); font-weight: 500;">Level</span>
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <button class="btn-icon level-down" data-index="${index}" style="padding: 0.25rem 0.5rem; font-size: 1.2rem; line-height: 1;">‚àí</button>
              <span style="font-size: 1.5rem; font-weight: 700; color: #f0d06b; font-family: 'Cinzel', serif; text-shadow: 0 0 10px rgba(212, 175, 55, 0.5); min-width: 2.5rem; text-align: center;">${char.level}</span>
              <button class="btn-icon level-up" data-index="${index}" style="padding: 0.25rem 0.5rem; font-size: 1.2rem; line-height: 1;">+</button>
            </div>
          </div>
        </div>
      `).join('');

      // Add event listeners
      document.querySelectorAll('.remove-character').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          if (confirm(`Remove ${party[index].name} from the party?`)) {
            party.splice(index, 1);
            saveParty();
          }
        });
      });

      // Level up buttons
      document.querySelectorAll('.level-up').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          if (party[index].level < 20) {
            party[index].level++;
            saveParty();
          }
        });
      });

      // Level down buttons
      document.querySelectorAll('.level-down').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          if (party[index].level > 1) {
            party[index].level--;
            saveParty();
          }
        });
      });
    }

    function addCharacter() {
      const name = document.getElementById('char-name').value.trim();
      const charClass = document.getElementById('char-class').value;
      const race = document.getElementById('char-race').value;
      const level = parseInt(document.getElementById('char-level').value);

      if (!name || !charClass || !race || !level) {
        alert('Please fill in all fields!');
        return;
      }

      party.push({
        id: Date.now(),
        name,
        class: charClass,
        race,
        level
      });

      // Clear form
      document.getElementById('char-name').value = '';
      document.getElementById('char-class').value = '';
      document.getElementById('char-race').value = '';
      document.getElementById('char-level').value = '1';

      saveParty();
    }

    function clearParty() {
      if (confirm('Clear entire party? This cannot be undone!')) {
        party = [];
        saveParty();
      }
    }

    function loadTemplate(template) {
      if (party.length > 0 && !confirm('This will replace your current party. Continue?')) {
        return;
      }

      party = [];

      switch (template) {
        case 'classic':
          party = [
            { id: Date.now(), name: 'Ragnar', class: 'Fighter', race: 'Human', level: 3 },
            { id: Date.now() + 1, name: 'Elara', class: 'Cleric', race: 'Elf', level: 3 },
            { id: Date.now() + 2, name: 'Finn', class: 'Rogue', race: 'Halfling', level: 3 },
            { id: Date.now() + 3, name: 'Myrra', class: 'Wizard', race: 'Human', level: 3 }
          ];
          break;
        case 'small':
          party = [
            { id: Date.now(), name: 'Thrain', class: 'Paladin', race: 'Dwarf', level: 5 },
            { id: Date.now() + 1, name: 'Sylara', class: 'Ranger', race: 'Elf', level: 5 },
            { id: Date.now() + 2, name: 'Zephyr', class: 'Sorcerer', race: 'Tiefling', level: 5 }
          ];
          break;
        case 'large':
          party = [
            { id: Date.now(), name: 'Bjorn', class: 'Barbarian', race: 'Half-Orc', level: 4 },
            { id: Date.now() + 1, name: 'Lyra', class: 'Bard', race: 'Half-Elf', level: 4 },
            { id: Date.now() + 2, name: 'Cedric', class: 'Fighter', race: 'Human', level: 4 },
            { id: Date.now() + 3, name: 'Aria', class: 'Cleric', race: 'Human', level: 4 },
            { id: Date.now() + 4, name: 'Sneak', class: 'Rogue', race: 'Halfling', level: 4 },
            { id: Date.now() + 5, name: 'Aldric', class: 'Wizard', race: 'Elf', level: 4 }
          ];
          break;
      }

      saveParty();
    }

    // Tab switching
    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.config-tab-content').forEach(tab => {
        tab.style.display = 'none';
      });

      // Show selected tab
      document.getElementById(`tab-${tabName}`).style.display = 'block';

      // Update tab buttons
      document.querySelectorAll('.config-tab').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
          btn.style.color = '#e8d5b7';
          btn.style.borderBottom = '3px solid #d4af37';
        } else {
          btn.classList.remove('active');
          btn.style.color = '#8b7355';
          btn.style.borderBottom = '3px solid transparent';
        }
      });

      // Update content based on tab
      if (tabName === 'campaign') {
        updateCampaignTab();
      } else if (tabName === 'session') {
        updateSessionTab();
      }
    }

    // Update campaign tab
    function updateCampaignTab() {
      const campaign = getActiveCampaign();
      if (!campaign) return;

      const settings = campaign.settings || {};
      const worldNames = {
        'forgotten-realms': 'Forgotten Realms', 'eberron': 'Eberron',
        'greyhawk': 'Greyhawk', 'dragonlance': 'Dragonlance',
        'ravenloft': 'Ravenloft', 'spelljammer': 'Spelljammer',
        'planescape': 'Planescape', 'dark-sun': 'Dark Sun',
        'mystara': 'Mystara', 'birthright': 'Birthright',
        'critical-role': 'Critical Role', 'homebrew': 'Homebrew', 'other': 'Other'
      };

      document.getElementById('campaign-details').innerHTML = `
        <div class="d-grid gap-md">
          <div class="p-md" style="background: rgba(212, 175, 55, 0.1); border-radius: 6px;">
            <strong class="text-gold">Campaign Name:</strong>
            <span class="text-primary ml-md">${escapeHTML(campaign.name)}</span>
          </div>
          <div class="p-md" style="background: rgba(212, 175, 55, 0.1); border-radius: 6px;">
            <strong class="text-gold">Edition:</strong>
            <span class="text-primary ml-md">${settings.edition || '5e'}</span>
          </div>
          <div class="p-md" style="background: rgba(212, 175, 55, 0.1); border-radius: 6px;">
            <strong class="text-gold">World/Setting:</strong>
            <span class="text-primary ml-md">${worldNames[settings.world] || 'Forgotten Realms'}</span>
          </div>
          <div class="p-md" style="background: rgba(212, 175, 55, 0.1); border-radius: 6px;">
            <strong class="text-gold">Campaign Code:</strong>
            <code class="text-gold-light ml-md" style="background: rgba(0,0,0,0.3); padding: 0.25rem 0.75rem; border-radius: 4px;">${campaign.code}</code>
          </div>
          <div class="p-md" style="background: rgba(212, 175, 55, 0.1); border-radius: 6px;">
            <strong class="text-gold">Created:</strong>
            <span class="text-primary ml-md">${new Date(campaign.createdAt).toLocaleDateString()}</span>
          </div>
        </div>
      `;
    }

    // Update session tab
    function updateSessionTab() {
      const campaign = getActiveCampaign();
      const session = getActiveSession();

      const controlsDiv = document.getElementById('session-controls');
      const historyDiv = document.getElementById('session-history');

      if (session) {
        const duration = Math.floor((Date.now() - session.startedAt) / 60000);
        controlsDiv.innerHTML = `
          <div style="text-align: center; padding: 2rem; background: linear-gradient(135deg, rgba(76, 175, 80, 0.2) 0%, rgba(212, 175, 55, 0.2) 100%); border-radius: 8px; border: 2px solid rgba(76, 175, 80, 0.5);">
            <h4 style="color: #4caf50; margin-bottom: 1rem;">‚úÖ Session Active</h4>
            <p style="color: #e8d5b7; font-size: 1.2rem; margin-bottom: 1.5rem;">Duration: ${duration} minutes</p>
            <button class="btn btn-secondary" onclick="showEndSessionModalConfig()" style="font-size: 1rem;">
              üö™ End Session
            </button>
          </div>
        `;
      } else {
        controlsDiv.innerHTML = `
          <div class="text-center p-xl" style="background: rgba(212, 175, 55, 0.1); border-radius: 8px;">
            <p class="text-muted mb-lg">No active session</p>
            <button class="btn btn-primary" onclick="window.location.href='index.html'">
              ‚öîÔ∏è Start New Session
            </button>
          </div>
        `;
      }

      // Session history
      if (campaign && campaign.sessions && campaign.sessions.length > 0) {
        historyDiv.innerHTML = campaign.sessions.slice().reverse().map((s, index) => `
          <div style="padding: 1rem; margin-bottom: 1rem; background: rgba(212, 175, 55, 0.05); border-left: 4px solid #d4af37; border-radius: 4px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
              <strong style="color: #d4af37;">Session ${campaign.sessions.length - index}</strong>
              <span style="color: #b8956a; font-size: 0.9rem;">${new Date(s.startedAt).toLocaleDateString()}</span>
            </div>
            <p style="color: #e8d5b7; font-size: 0.9rem; line-height: 1.6;">${escapeHTML(s.notes || 'No notes')}</p>
          </div>
        `).join('');
      } else {
        historyDiv.innerHTML = '<p style="color: #b8956a; text-align: center;">No sessions yet</p>';
      }
    }

    // Show end session modal
    function showEndSessionModalConfig() {
      document.getElementById('end-session-modal-config').style.display = 'flex';
    }

    // End session from config
    function endSessionFromConfig() {
      const notes = document.getElementById('session-notes-textarea-config').value;
      const campaign = getActiveCampaign();

      endSession(notes);

      alert(`Session ended!\n\nYour campaign code: ${campaign.code}`);

      document.getElementById('end-session-modal-config').style.display = 'none';
      updateSessionTab();
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      // Tab buttons
      document.querySelectorAll('.config-tab').forEach(btn => {
        btn.addEventListener('click', () => switchTab(btn.dataset.tab));
      });

      document.getElementById('add-character-btn').addEventListener('click', addCharacter);
      document.getElementById('clear-party-btn').addEventListener('click', clearParty);

      // Enter key support
      ['char-name', 'char-class', 'char-race', 'char-level'].forEach(id => {
        document.getElementById(id).addEventListener('keyup', (e) => {
          if (e.key === 'Enter') addCharacter();
        });
      });

      // Template buttons
      document.querySelectorAll('.template-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const template = e.target.dataset.template;
          loadTemplate(template);
        });
      });

      // Confirm party button
      document.getElementById('confirm-party-btn').addEventListener('click', () => {
        if (party.length === 0) {
          alert('Please add at least one character to your party first.');
          return;
        }

        if (confirm(`Confirm your party of ${party.length} member(s)?\n\nYou can still adjust levels later, but you'll be ready to start your first session!`)) {
          // Mark party as confirmed in campaign
          const campaign = getActiveCampaign();
          if (campaign) {
            campaign.partyConfirmed = true;
            campaign.party = party;
            saveCampaign();
          }

          // Show success and redirect to home
          alert('Party confirmed! üéâ\n\nYou can now start your first session from the home page.');
          window.location.href = 'index.html';
        }
      });

      loadParty();
      renderParty();
      updateConfirmButton();

      // Language selector
      const languageSelector = document.getElementById('language-selector');
      if (languageSelector) {
        // Set current language
        languageSelector.value = getCurrentLanguage();

        // Listen for changes
        languageSelector.addEventListener('change', (e) => {
          window.changeLanguage(e.target.value);
        });
      }
    });

    // D&D Beyond Import Logic
    function showImportModal() {
      document.getElementById('import-dndb-modal').style.display = 'flex';
      document.getElementById('dndb-json-input').value = '';
      document.getElementById('import-error').style.display = 'none';
      document.getElementById('dndb-json-input').focus();
    }

    function hideImportModal() {
      document.getElementById('import-dndb-modal').style.display = 'none';
    }

    function processImport() {
      const jsonInput = document.getElementById('dndb-json-input').value.trim();
      const errorDiv = document.getElementById('import-error');

      if (!jsonInput) {
        errorDiv.textContent = 'Please paste some JSON data or fetch from URL first.';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const character = DndBeyondParser.parse(jsonInput);

        // Add to party
        party.push(character);
        saveParty();

        // Success
        hideImportModal();
        alert(`Successfully imported ${character.name} (Level ${character.level} ${character.race} ${character.class})!\n\nStats: HP ${character.hp.max} | AC ${character.ac} | STR ${character.stats.STR} DEX ${character.stats.DEX}`);

      } catch (err) {
        errorDiv.textContent = err.message;
        errorDiv.style.display = 'block';
      }
    }

    async function fetchCharacterFromUrl() {
      const urlInput = document.getElementById('dndb-url-input');
      const status = document.getElementById('fetch-status');
      const jsonArea = document.getElementById('dndb-json-input');

      const url = urlInput.value.trim();

      if (!url) {
        status.style.display = 'block';
        status.innerHTML = '<span class="text-danger">Please enter a URL</span>';
        return;
      }

      status.style.display = 'block';
      status.innerHTML = '<span class="text-gold">Fetching... (this needs Vercel deployment)</span>';

      try {
        // Use Vercel Serverless Function Proxy
        const proxyUrl = `/api/dndb-proxy?url=${encodeURIComponent(url)}`;

        const response = await fetch(proxyUrl);

        if (!response.ok) {
          // Fallback message for local development
          if (response.status === 404) {
            throw new Error('Proxy API not found. Are you running local? Deploy to Vercel to use URL fetch.');
          }
          const err = await response.json();
          throw new Error(err.error || 'Fetch failed');
        }

        const data = await response.json();

        // Auto-fill JSON area
        jsonArea.value = JSON.stringify(data, null, 2);
        status.innerHTML = '<span class="text-success">‚úì Data fetched! Click "Import Character" below.</span>';

      } catch (error) {
        console.error(error);
        // If local, show helpful message
        if (window.location.hostname === 'localhost' || window.location.protocol === 'file:') {
          status.innerHTML = `<span class="text-warning">‚ö†Ô∏è URL Fetch requires Vercel Proxy. <br>For local test, please paste JSON manually.</span>`;
        } else {
          status.innerHTML = `<span class="text-danger">‚ùå Error: ${error.message}</span>`;
        }
      }
    }

    // Add import event listeners
    document.addEventListener('DOMContentLoaded', () => {
      const importBtn = document.getElementById('import-dndb-btn');
      if (importBtn) {
        importBtn.addEventListener('click', showImportModal);
      }

      const fetchBtn = document.getElementById('fetch-dndb-btn');
      if (fetchBtn) {
        fetchBtn.addEventListener('click', fetchCharacterFromUrl);
      }

      const processBtn = document.getElementById('process-import-btn');
      if (processBtn) {
        processBtn.addEventListener('click', processImport);
      }

      const cancelBtn = document.getElementById('cancel-import-btn');
      if (cancelBtn) {
        cancelBtn.addEventListener('click', hideImportModal);
      }

      const modal = document.getElementById('import-dndb-modal');
      if (modal) {
        modal.addEventListener('click', (e) => {
          if (e.target.id === 'import-dndb-modal') hideImportModal();
        });
      }
    });
  </script>
</body>

</html>
