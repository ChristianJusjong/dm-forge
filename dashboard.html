<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dungeon Master Forge - Home</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="design-system.css">
  <link rel="stylesheet" href="medieval-theme.css">
  <link rel="stylesheet" href="responsive-design.css">
  <link rel="stylesheet" href="global-overrides.css">
</head>

<body>
  <div id="app">
    <!-- Navigation will be inserted here by nav.js -->

    <!-- Hero Section -->
    <main class="hero-section hero-section-enhanced stone-texture">
      <div class="hero-content">
        <div class="hero-logo-container">
          <div class="hero-logo-glow" aria-hidden="true"></div>
          <div class="hero-logo-wrapper">
            <img src="logo.svg"
              alt="Dungeon Master Forge - A glowing golden dragon emblem surrounded by mystical runes">
          </div>
          <h1 class="medieval-title">Dungeon Master Forge</h1>
          <div class="medieval-divider" aria-hidden="true"></div>
          <p class="hero-subtitle" data-i18n="welcomeSubtitle">Your Ultimate Campaign Companion</p>
        </div>

        <!-- Campaign Info & Session Management -->
        <div id="campaign-info" class="card mx-auto text-center mb-xl" style="max-width: 800px;"></div>

        <!-- Feature Cards Grid -->
        <div class="cards-grid">
          <!-- Configuration Card -->
          <a href="configuration.html" class="feature-card feature-card-enhanced" data-category="setup">
            <div class="card-icon">âš™ï¸</div>
            <h3 data-i18n="configuration">Configuration</h3>
            <p>Configure your campaign, party, and session settings</p>
            <div class="card-footer">
              <span class="card-tag">Setup</span>
            </div>
          </a>

          <!-- Initiative Tracker Card -->
          <a href="initiative.html" class="feature-card feature-card-enhanced" data-category="combat">
            <div class="card-icon torch-glow">âš”ï¸</div>
            <h3 data-i18n="initiative">Initiative Tracker</h3>
            <p data-i18n="initiativeDesc">Track combat initiative, HP, AC, and conditions in real-time</p>
            <div class="card-footer">
              <span class="card-tag">Combat</span>
            </div>
          </a>

          <!-- Encounter Builder Card -->
          <a href="encounters.html" class="feature-card feature-card-enhanced" data-category="combat">
            <div class="card-icon torch-glow">ğŸ‘¹</div>
            <h3 data-i18n="encounters">Encounter Builder</h3>
            <p data-i18n="encountersDesc">Design and balance encounters for your party</p>
            <div class="card-footer">
              <span class="card-tag">Combat</span>
            </div>
          </a>

          <!-- Monster Browser Card -->
          <a href="monsters.html" class="feature-card feature-card-enhanced" data-category="reference">
            <div class="card-icon torch-glow">ğŸ‰</div>
            <h3 data-i18n="monsters">Monster Browser</h3>
            <p>Browse SRD monsters with D&D Beyond integration</p>
            <div class="card-footer">
              <span class="card-tag">Reference</span>
            </div>
          </a>

          <!-- NPC Generator Card -->
          <a href="npcs.html" class="feature-card feature-card-enhanced" data-category="creative">
            <div class="card-icon torch-glow">ğŸ§™</div>
            <h3 data-i18n="npcs">NPC Generator</h3>
            <p data-i18n="npcsDesc">AI-powered NPC creation with Gemini</p>
            <div class="card-footer">
              <span class="card-tag">AI-Powered</span>
            </div>
          </a>

          <!-- Inspiration & Random Tables Card -->
          <a href="inspiration.html" class="feature-card feature-card-enhanced" data-category="creative">
            <div class="card-icon torch-glow">âœ¨</div>
            <h3 data-i18n="inspiration">Inspiration & Tables</h3>
            <p data-i18n="inspirationDesc">Random generators and dice roller</p>
            <div class="card-footer">
              <span class="card-tag">Random</span>
            </div>
          </a>

          <!-- Session Notes Card -->
          <a href="notes.html" class="feature-card feature-card-enhanced" data-category="organization">
            <div class="card-icon torch-glow">ğŸ“</div>
            <h3 data-i18n="notes">Session Notes</h3>
            <p data-i18n="notesDesc">Track your campaign and session details</p>
            <div class="card-footer">
              <span class="card-tag">Organization</span>
            </div>
          </a>

          <!-- API Test Card -->
          <a href="api-test.html" class="feature-card feature-card-enhanced" data-category="reference"
            style="opacity: 0.8; border: 2px dashed var(--wood-brown);">
            <div class="card-icon">ğŸ”§</div>
            <h3>API Test</h3>
            <p>Test connection to all external APIs (Groq, Gemini, Open5e)</p>
            <div class="card-footer">
              <span class="card-tag" style="background: var(--iron);">Tools</span>
            </div>
          </a>
        </div>
      </div>
    </main>
  </div>

  <!-- End Session Modal -->
  <div id="end-session-modal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h2 class="text-gold mb-lg">ğŸ“œ End Session</h2>

      <p class="mb-lg" style="line-height: 1.8;">
        Save your session and get your campaign code to continue later.
      </p>

      <div class="input-group">
        <label class="input-label">Session Notes (Optional)</label>
        <textarea id="session-notes-textarea" class="textarea" rows="5"
          placeholder="What happened in this session?"></textarea>
      </div>

      <div class="modal-actions mt-xl">
        <button class="btn btn-primary" onclick="endSessionNow()">
          ğŸ’¾ End Session
        </button>
        <button class="btn" onclick="document.getElementById('end-session-modal').style.display='none'">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script type="module" src="storage-utils.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="translations.js"></script>
  <script type="module" src="campaign-manager.js"></script>
  <!-- Import Session Managers -->
  <script type="module" src="cloud-store.js"></script>
  <script type="module" src="session-manager.js"></script>

  <script type="module" src="nav.js"></script>
  <script type="module" src="tutorial.js"></script>
  <script type="module" src="ads.js"></script>
  <script type="module">
    import { sessionManager } from './session-manager.js';
    import { db } from './cloud-store.js';

    // Make available to window for inline onclick handlers
    window.sessionManager = sessionManager;

    // Wait for modules to load
    window.addEventListener('load', () => {
      // Require authentication
      if (typeof requireAuth === 'function' && !requireAuth()) {
        // User will be redirected to login
        throw new Error('Authentication required');
      }

      // Initialize Session UI
      renderSessionHistory();
    });

    // Display campaign info and session management
    window.updateCampaignInfo = function () {
      const campaign = getActiveCampaign();
      const session = getActiveSession(); // This is the old "active session" check from campaign-manager
      const infoDiv = document.getElementById('campaign-info');

      if (!campaign) {
        // No campaign - show new campaign button
        infoDiv.style.display = 'block';
        infoDiv.innerHTML = `
          <h2 class="text-gold mb-md">âš”ï¸ No Active Campaign</h2>
          <p class="text-primary mb-lg" style="line-height: 1.8;">
            Start a new campaign or load an existing one to begin your adventure.
          </p>
          <button class="btn btn-primary" onclick="window.location.href='campaign-start.html'">
            ğŸ² Start / Load Campaign
          </button>
        `;
        return;
      }

      infoDiv.style.display = 'block';

      // NEW: Enhanced Dashboard with Session Manager Controls
      if (!session) {
        // No active session - show start button AND Restore options
        const settings = campaign.settings || {};

        infoDiv.innerHTML = `
          <h2 class="text-gold mb-sm">ğŸ“– ${escapeHTML(campaign.name)}</h2>
          <p class="text-muted text-sm mb-md">
            ${settings.world || 'Forgotten Realms'} â€¢ Code: <code>${campaign.code}</code>
          </p>
          
          <div class="session-controls" style="background: rgba(0, 0, 0, 0.3); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border-dark);">
            <h3 class="text-gold-light mb-md" style="font-size: 1.1rem;">ğŸ›¡ï¸ Session Command</h3>
            <div class="d-flex flex-wrap justify-center gap-md">
              <button class="btn btn-primary" onclick="window.startNewSession()">
                âš”ï¸ Start New Session
              </button>
              <button class="btn btn-secondary" onclick="window.renderSessionHistory(true)">
                ğŸ“‚ Load Previous Session
              </button>
            </div>
            <div id="session-history-container" class="mt-lg" style="display:none; text-align: left;">
                <h4 class="text-muted text-xs uppercase mb-sm">Recent Sessions</h4>
                <div id="session-history-list" class="flex-column gap-sm">
                    <!-- Populated by JS -->
                </div>
            </div>
          </div>
          
          <div class="mt-md d-flex justify-center gap-sm">
             <button class="btn-tiny btn-secondary" onclick="window.location.href='configuration.html'">âš™ï¸ Configure</button>
             <button class="btn-tiny btn-secondary" onclick="window.location.href='campaign-start.html'">ğŸ”„ Switch Campaign</button>
          </div>
        `;
      } else {
        // Active session - show session info and end button
        const duration = Math.floor((Date.now() - session.startedAt) / 60000);
        infoDiv.innerHTML = `
          <h2 class="text-gold mb-sm">ğŸ“– ${escapeHTML(campaign.name)}</h2>
          <div style="background: rgba(40, 167, 69, 0.1); border: 1px solid #28a745; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
            <p class="text-success text-bold mb-sm" style="font-size: 1.1rem;">
              âœ… Session Active
            </p>
            <p class="text-sm text-primary mb-md">Running for ${duration} minutes</p>
            <button class="btn btn-danger" onclick="showEndSessionModal()">
              ğŸšª Close Session & Save
            </button>
          </div>
        `;
      }
    }

    // New: Render Session History
    window.renderSessionHistory = async function (toggle = false) {
      const container = document.getElementById('session-history-container');
      const list = document.getElementById('session-history-list');

      if (toggle && container) {
        container.style.display = container.style.display === 'none' ? 'block' : 'none';
      }

      if (!list) return;

      const sessions = await sessionManager.getSessionHistory();
      if (sessions.length === 0) {
        list.innerHTML = '<p class="text-muted text-sm text-center">No saved sessions found.</p>';
        return;
      }

      list.innerHTML = sessions.map(s => `
            <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 4px; border: 1px solid var(--border-dark); display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div class="text-gold-light text-sm font-bold">Session ${new Date(s.timestamp).toLocaleDateString()}</div>
                    <div class="text-muted text-xs text-truncate" style="max-width: 200px;">${s.closingNotes || 'No notes'}</div>
                </div>
                <button class="btn-tiny btn-secondary" onclick="restoreSession('${s.id}')">Restore â†©ï¸</button>
            </div>
        `).join('');
    }

    window.restoreSession = async function (id) {
      if (confirm('Restoring this session will overwrite your current initiative board. Continue?')) {
        try {
          await sessionManager.restoreSession(id);
          alert('Session restored!');
          window.location.href = 'initiative.html';
        } catch (e) {
          alert('Error restoring session: ' + e.message);
        }
      }
    }

    // Start new session (Wrapper)
    window.startNewSession = function () {
      const campaign = getActiveCampaign();
      if (!campaign) {
        alert('No active campaign found!');
        window.location.href = 'campaign-start.html';
        return;
      }

      // Start the "Legacy" session tracker (for compatibility with existing code)
      startSession();
      updateCampaignInfo();
      window.location.href = 'notes.html';
    }

    // Show end session modal
    window.showEndSessionModal = function () {
      document.getElementById('end-session-modal').style.display = 'flex';
    }

    // End session now
    window.endSessionNow = async function () {
      const notes = document.getElementById('session-notes-textarea').value;
      const campaign = getActiveCampaign();

      // 1. New Session Manager Logic
      const sessionId = 'sess_' + Date.now();
      await sessionManager.closeSession(sessionId, notes);

      // 2. Legacy Logic (to keep campaign-manager.js happy)
      endSession(notes);

      alert(`Session closed and saved successfully!`);

      document.getElementById('end-session-modal').style.display = 'none';
      updateCampaignInfo();
    }

    // Add staggered entrance animation to cards
    window.addEventListener('load', () => {
      // Small delay to ensure DB is ready
      setTimeout(updateCampaignInfo, 100);

      const cards = document.querySelectorAll('.feature-card');
      cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
      });
    });
  </script>
</body>

</html>