<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Backup & Export - Dungeon Master Forge</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="design-system.css">
  <link rel="stylesheet" href="medieval-theme.css">
  <link rel="stylesheet" href="responsive-design.css">
  <link rel="stylesheet" href="global-overrides.css">
</head>
</head>

<body>
  <div id="app">
    <!-- Navigation will be inserted here by nav.js -->

    <main class="page-content">
      <div class="page-header">
        <h1 class="page-title">üíæ Data Backup & Export</h1>
        <p class="page-subtitle">Protect your campaigns from data loss</p>
      </div>

      <!-- Warning Banner -->
      <div class="warning-box">
        <h3 class="text-warning mb-md">‚ö†Ô∏è Important: Your Data is Stored Locally</h3>
        <p class="text-primary mb-md">
          All your campaign data is stored in your browser's local storage. This means:
        </p>
        <ul class="text-primary ml-lg">
          <li>Clearing browser cache = <strong>permanent data loss</strong></li>
          <li>Switching browsers = data doesn't transfer</li>
          <li>No automatic backups or cloud sync</li>
          <li>Computer crash = potential data loss</li>
        </ul>
        <p class="text-warning mt-md text-semibold">
          üìå Regular backups are <strong>essential</strong> to prevent losing months of campaign work!
        </p>
      </div>

      <!-- Storage Usage -->
      <div class="backup-card">
        <h2 class="text-gold mb-lg">üìä Storage Usage</h2>
        <div id="storage-info">
          <p class="text-primary">Calculating...</p>
        </div>
        <div class="storage-meter">
          <div class="storage-fill" id="storage-meter" style="width: 0%">0%</div>
        </div>
        <p class="text-muted text-sm mt-sm">
          Typical localStorage limit: ~5-10 MB
        </p>
      </div>

      <!-- Export All Data -->
      <div class="backup-card">
        <h2 class="text-gold mb-md">üì• Export All Data</h2>
        <p class="text-primary mb-lg">
          Download a complete backup of <strong>all your data</strong> including campaigns, sessions, notes, NPCs, and
          encounters.
        </p>
        <button class="btn btn-primary text-lg" onclick="doExportAll()">
          üíæ Export Complete Backup
        </button>
        <p class="text-muted text-xs mt-md">
          Last backup: <span id="last-backup">Never</span>
        </p>
      </div>

      <!-- Export Campaign Only -->
      <div class="backup-card">
        <h2 class="text-gold mb-md">üì§ Export Campaign</h2>
        <p class="text-primary mb-lg">
          Export a specific campaign or all campaigns separately.
        </p>

        <div id="campaign-list" class="mb-lg">
          <p class="text-primary">Loading campaigns...</p>
        </div>

        <button class="btn btn-secondary" onclick="exportAllCampaigns()">
          üì¶ Export All Campaigns
        </button>
      </div>

      <!-- Import Data -->
      <div class="backup-card">
        <h2 class="text-gold mb-md">üì§ Import / Restore Data</h2>
        <p class="text-primary mb-lg">
          Restore data from a previously exported backup file.
        </p>

        <div class="warning-box danger">
          <p class="text-bold mb-sm">‚ö†Ô∏è Warning: This will overwrite your
            current data!</p>
          <p class="text-primary text-sm">
            Make sure to export your current data first before importing.
          </p>
        </div>

        <label for="import-file" class="file-input-label">
          üìÇ Choose Backup File
        </label>
        <input type="file" id="import-file" accept=".json" onchange="handleFileImport(this)">
      </div>

      <!-- Best Practices -->
      <div class="info-box">
        <h3 class="text-success mb-md">‚úÖ Backup Best Practices</h3>
        <ul class="text-primary ml-lg">
          <li><strong>Weekly backups:</strong> Export your data at least once a week</li>
          <li><strong>Before updates:</strong> Always backup before browser/OS updates</li>
          <li><strong>Multiple locations:</strong> Store backups in cloud storage (Google Drive, Dropbox, etc.)</li>
          <li><strong>Version backups:</strong> Keep multiple backup versions (don't overwrite)</li>
          <li><strong>Test restores:</strong> Periodically test that your backups work</li>
        </ul>
      </div>
    </main>
  </div>

  <script src="storage-utils.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="translations.js"></script>
  <script type="module" src="campaign-manager.js"></script>
  <script src="data-manager.js"></script>
  <script type="module" src="nav.js"></script>
  <script type="module" src="ads.js"></script>
  <script>
    // Wait for modules to load
    window.addEventListener('load', () => {
      // Require authentication
      if (typeof requireAuth === 'function' && !requireAuth()) {
        throw new Error('Authentication required');
      }
    });

    // Update storage usage display
    function updateStorageDisplay() {
      const usage = checkStorageUsage();
      if (!usage) return;

      const infoDiv = document.getElementById('storage-info');
      infoDiv.innerHTML = `
        <p class="text-lg text-primary mb-sm">
          <strong>${usage.sizeKB} KB</strong> used (${usage.sizeMB} MB)
        </p>
        <p class="text-semibold" style="color: ${usage.usagePercent > 80 ? '#ff9800' : '#4caf50'};">
          ${usage.usagePercent}% of estimated 5 MB quota
        </p>
      `;

      const meter = document.getElementById('storage-meter');
      meter.style.width = `${Math.min(usage.usagePercent, 100)}%`;
      meter.textContent = `${usage.usagePercent}%`;
    }

    // Export all data wrapper
    function doExportAll() {
      if (exportAllData()) {
        recordBackup();
        updateLastBackupDisplay();
      }
    }

    // Update last backup date display
    function updateLastBackupDisplay() {
      const lastBackup = localStorage.getItem('last_backup_date');
      const span = document.getElementById('last-backup');

      if (lastBackup) {
        const date = new Date(parseInt(lastBackup));
        span.textContent = date.toLocaleString();
        span.style.color = '#4caf50';
      } else {
        span.textContent = 'Never';
        span.style.color = '#ff9800';
      }
    }

    // Load campaigns list
    function loadCampaignsList() {
      const listDiv = document.getElementById('campaign-list');
      const campaigns = [];

      // Find all campaign keys
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('campaign_')) {
          try {
            const code = key.replace('campaign_', '');
            const data = JSON.parse(localStorage.getItem(key));
            campaigns.push({ code, name: data.name || 'Unnamed Campaign' });
          } catch (error) {
            console.error('Failed to parse campaign:', key, error);
          }
        }
      }

      if (campaigns.length === 0) {
        listDiv.innerHTML = '<p class="text-muted">No campaigns found</p>';
        return;
      }

      listDiv.innerHTML = campaigns.map(campaign => `
        <div class="d-flex justify-between align-center p-md mb-sm" style="background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
          <div>
            <strong class="text-gold">${escapeHTML(campaign.name)}</strong>
            <br>
            <small class="text-muted">Code: ${campaign.code}</small>
          </div>
          <button class="btn" onclick="exportSingleCampaign('${campaign.code}')">
            üì• Export
          </button>
        </div>
      `).join('');
    }

    // Export single campaign
    function exportSingleCampaign(code) {
      exportCampaignData(code);
    }

    // Export all campaigns
    function exportAllCampaigns() {
      exportCampaignData();
    }

    // Handle file import
    function handleFileImport(input) {
      if (input.files && input.files[0]) {
        importData(input.files[0]);
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      updateStorageDisplay();
      updateLastBackupDisplay();
      loadCampaignsList();
    });
  </script>
</body>

</html>