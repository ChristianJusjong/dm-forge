<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Start Campaign - Dungeon Master Forge</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="design-system.css">
  <link rel="stylesheet" href="medieval-theme.css">
  <link rel="stylesheet" href="responsive-design.css">
  <link rel="manifest" href="manifest.json">
</head>

<body>
  <div id="app">
    <!-- Navigation will be inserted here by nav.js -->

    <main class="page-content">
      <div class="campaign-hero">
        <img src="logo-icon.svg" alt="DM Codex" class="d-block mx-auto mb-lg" style="width: 100px; height: 100px;">
        <h1>Welcome, Dungeon Master</h1>
        <p class="text-xl text-primary mx-auto mb-2xl" style="max-width: 700px; line-height: 1.8;">
          Begin your adventure by creating a new campaign or continue an existing one.
        </p>
      </div>

      <!-- New Campaign Card -->
      <div class="mx-auto mb-2xl" style="max-width: 600px;">
        <div class="campaign-option-card" onclick="showNewCampaignModal()">
          <div class="campaign-option-icon">üé≤</div>
          <h2 data-i18n="newCampaign">New Campaign</h2>
          <p data-i18n="newCampaignDesc">Start a fresh adventure. Create your party, manage encounters, and forge your
            legend.</p>
          <button class="btn btn-primary" data-i18n="startNew">Start New Campaign</button>
        </div>
      </div>

      <!-- Recent Campaigns -->
      <div id="recent-campaigns" class="card mx-auto mb-2xl d-none" style="max-width: 1200px;">
        <div class="d-flex justify-between align-center mb-lg">
          <h2 class="text-gold m-0">üìö Your Campaigns</h2>
          <button onclick="showLoadCampaignModal()" class="btn btn-secondary text-sm p-sm">
            üîë Enter Code
          </button>
        </div>
        <div id="recent-campaigns-list" class="cards-grid"></div>
      </div>
    </main>

    <!-- New Campaign Modal -->
    <div id="new-campaign-modal" class="modal-overlay" style="display: none;">
      <div class="modal modal-content-campaign" style="max-width: 600px;">
        <h2 class="text-gold mb-lg">üé≤ Create New Campaign</h2>

        <div class="input-group">
          <label class="input-label" data-i18n="campaignName">Campaign Name</label>
          <input id="campaign-name-input" type="text" placeholder="e.g., The Lost Mines of Phandelver" class="input">
        </div>

        <div class="input-group" style="margin-top: 1.5rem;">
          <label class="input-label">D&D Edition</label>
          <select id="campaign-edition" class="input">
            <optgroup label="5th Edition">
              <option value="5e-2024" selected>5th Edition (2024)</option>
              <option value="5e-2014">5th Edition (2014)</option>
            </optgroup>
            <optgroup label="Earlier Editions">
              <option value="4e-2008">4th Edition (2008)</option>
              <option value="3.5e-2003">3.5 Edition (2003)</option>
              <option value="3e-2000">3rd Edition (2000)</option>
              <option value="2e-1989">2nd Edition (1989)</option>
              <option value="1e-1977">1st Edition (1977)</option>
              <option value="oe-1974">Original D&D (1974)</option>
            </optgroup>
            <optgroup label="Pathfinder">
              <option value="pf2-2019">Pathfinder 2e (2019)</option>
              <option value="pf1-2009">Pathfinder 1e (2009)</option>
            </optgroup>
            <optgroup label="Other">
              <option value="other">Other/Homebrew</option>
            </optgroup>
          </select>
        </div>

        <div class="input-group" style="margin-top: 1.5rem;">
          <label class="input-label">Campaign Setting / World</label>
          <select id="campaign-world" class="input">
            <optgroup label="Official D&D Settings">
              <option value="forgotten-realms" selected>Forgotten Realms</option>
              <option value="eberron">Eberron</option>
              <option value="greyhawk">Greyhawk</option>
              <option value="dragonlance">Dragonlance</option>
              <option value="ravenloft">Ravenloft</option>
              <option value="spelljammer">Spelljammer</option>
              <option value="planescape">Planescape</option>
              <option value="dark-sun">Dark Sun</option>
              <option value="mystara">Mystara</option>
              <option value="birthright">Birthright</option>
            </optgroup>
            <optgroup label="Other Settings">
              <option value="critical-role">Critical Role (Exandria)</option>
              <option value="homebrew">Homebrew / Custom World</option>
              <option value="other">Other Setting</option>
            </optgroup>
          </select>
        </div>

        <div class="modal-actions mt-xl">
          <button class="btn btn-primary" onclick="createNewCampaign()">
            ‚öîÔ∏è <span data-i18n="create">Create</span>
          </button>
          <button class="btn" onclick="closeModal('new-campaign-modal')" data-i18n="cancel">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Load Campaign Modal -->
    <div id="load-campaign-modal" class="modal-overlay" style="display: none;">
      <div class="modal modal-content-campaign">
        <h2 class="text-gold mb-lg">üìú Load Campaign</h2>

        <div class="input-group">
          <label class="input-label" data-i18n="enterCode">Enter Campaign Code</label>
          <input id="campaign-code-input" type="text" placeholder="XXXX-XXXX" class="input code-input" maxlength="9">
          <p style="font-size: 0.9rem; color: #8b7355; margin-top: 0.5rem;">
            Enter the 8-character code you received when closing your last session.
          </p>
        </div>

        <div id="load-error" class="error-message" style="display: none; margin-top: 1rem;"></div>

        <div class="modal-actions mt-xl">
          <button class="btn btn-primary" onclick="loadExistingCampaign()">
            üìñ <span data-i18n="load">Load</span>
          </button>
          <button class="btn" onclick="closeModal('load-campaign-modal')" data-i18n="cancel">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <script src="storage-utils.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="translations.js"></script>
  <script type="module" src="campaign-manager.ts"></script>
  <script type="module" src="nav.js"></script>
  <script type="module" src="ads.js"></script>
  <script>
    // Wait for modules to load before checking auth
    window.addEventListener('load', () => {
      // Require authentication
      if (typeof requireAuth === 'function' && !requireAuth()) {
        // User will be redirected to login
        throw new Error('Authentication required');
      }
    });

    // Show new campaign modal
    function showNewCampaignModal() {
      document.getElementById('new-campaign-modal').style.display = 'flex';
      document.getElementById('campaign-name-input').focus();
    }

    // Show load campaign modal
    function showLoadCampaignModal() {
      document.getElementById('load-campaign-modal').style.display = 'flex';
      document.getElementById('campaign-code-input').focus();
    }

    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }

    // Create new campaign
    function createNewCampaign() {
      const nameInput = document.getElementById('campaign-name-input');
      const editionSelect = document.getElementById('campaign-edition');
      const worldSelect = document.getElementById('campaign-world');

      const name = nameInput.value.trim();
      const edition = editionSelect.value;
      const world = worldSelect.value;

      if (!name) {
        alert('Please enter a campaign name.');
        nameInput.focus();
        return;
      }

      const settings = {
        edition: edition,
        world: world
      };

      const campaign = createCampaign(name, settings);

      // Get world name for display
      const worldName = worldSelect.options[worldSelect.selectedIndex].text;
      const editionName = editionSelect.options[editionSelect.selectedIndex].text;

      // Show success and redirect to party setup
      alert(`Campaign created!\n\nName: ${name}\nSetting: ${worldName}\nEdition: ${editionName}\n\nYour campaign code: ${campaign.code}\n\nKeep this code safe - you'll need it to continue your campaign later!`);

      window.location.href = 'configuration.html';
    }

    // Load existing campaign
    function loadExistingCampaign() {
      const codeInput = document.getElementById('campaign-code-input');
      const code = codeInput.value.trim();

      if (!code) {
        showLoadError('Please enter a campaign code.');
        codeInput.focus();
        return;
      }

      const campaign = loadCampaign(code);

      if (!campaign) {
        showLoadError('Campaign not found. Please check your code and try again.');
        codeInput.focus();
        return;
      }

      // Redirect to party setup or directly to campaign dashboard
      if (!campaign.party || campaign.party.length === 0) {
        window.location.href = 'configuration.html';
      } else {
        window.location.href = 'index.html';
      }
    }

    // Show load error
    function showLoadError(message) {
      const errorDiv = document.getElementById('load-error');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';

      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // Load and display user's campaigns
    function loadUserCampaigns() {
      const currentUser = getCurrentUser();
      if (!currentUser) {
        return;
      }

      const campaigns = getUserCampaigns(currentUser.username);
      const recentCampaignsSection = document.getElementById('recent-campaigns');
      const recentCampaignsList = document.getElementById('recent-campaigns-list');

      if (campaigns.length === 0) {
        recentCampaignsSection.style.display = 'none';
        return;
      }

      // Show the section
      recentCampaignsSection.style.display = 'block';

      // Clear existing content
      recentCampaignsList.innerHTML = '';

      // Create campaign cards
      campaigns.forEach(campaign => {
        const card = document.createElement('div');
        card.className = 'recent-campaign-card';

        const lastAccessedDate = new Date(campaign.lastAccessed);
        const formattedDate = formatRelativeTime(lastAccessedDate);

        card.innerHTML = `
          <div>
            <div class="recent-campaign-header">
              <div>
                <h3 class="recent-campaign-name">${escapeHtml(campaign.name)}</h3>
                <div class="recent-campaign-code">Code: ${campaign.code}</div>
              </div>
            </div>
            <div class="recent-campaign-date">Last played: ${formattedDate}</div>
          </div>
          <div class="recent-campaign-footer">
            <button class="btn btn-primary btn-small" onclick="loadCampaignByCode('${campaign.code}')">
              ‚öîÔ∏è Select Campaign
            </button>
          </div>
        `;

        recentCampaignsList.appendChild(card);
      });
    }

    // Load campaign by code and redirect
    function loadCampaignByCode(code) {
      const campaign = loadCampaign(code);

      if (!campaign) {
        alert('Campaign not found. It may have been deleted.');
        loadUserCampaigns(); // Refresh the list
        return;
      }

      // Redirect to party setup or directly to campaign dashboard
      if (!campaign.party || campaign.party.length === 0) {
        window.location.href = 'configuration.html';
      } else {
        window.location.href = 'index.html';
      }
    }

    // Format relative time (e.g., "2 hours ago", "3 days ago")
    function formatRelativeTime(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffSecs = Math.floor(diffMs / 1000);
      const diffMins = Math.floor(diffSecs / 60);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);

      if (diffSecs < 60) {
        return 'Just now';
      } else if (diffMins < 60) {
        return `${diffMins} minute${diffMins === 1 ? '' : 's'} ago`;
      } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours === 1 ? '' : 's'} ago`;
      } else if (diffDays < 7) {
        return `${diffDays} day${diffDays === 1 ? '' : 's'} ago`;
      } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7);
        return `${weeks} week${weeks === 1 ? '' : 's'} ago`;
      } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30);
        return `${months} month${months === 1 ? '' : 's'} ago`;
      } else {
        const years = Math.floor(diffDays / 365);
        return `${years} year${years === 1 ? '' : 's'} ago`;
      }
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Auto-format code input
    document.addEventListener('DOMContentLoaded', () => {
      const codeInput = document.getElementById('campaign-code-input');

      codeInput.addEventListener('input', (e) => {
        let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');

        if (value.length > 4) {
          value = value.slice(0, 4) + '-' + value.slice(4, 8);
        }

        e.target.value = value;
      });

      // Enter key support
      document.getElementById('campaign-name-input').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') createNewCampaign();
      });

      document.getElementById('campaign-code-input').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') loadExistingCampaign();
      });

      // Load user's recent campaigns
      loadUserCampaigns();

      // Check if there's already an active campaign
      const activeCampaign = getActiveCampaign();
      if (activeCampaign) {
        // Show option to continue
        const hero = document.querySelector('.campaign-hero');
        hero.innerHTML = `
          <h1>‚öîÔ∏è Welcome Back, Dungeon Master</h1>
          <p class="text-xl text-primary mx-auto mb-xl" style="max-width: 700px; line-height: 1.8;">
            You have an active campaign: <strong class="text-gold">${activeCampaign.name}</strong>
          </p>
          <button class="btn btn-primary text-lg px-xl py-md" onclick="window.location.href='index.html'">
            ‚öîÔ∏è Continue Campaign
          </button>
          <button class="btn text-md px-xl py-md ml-md" onclick="clearActiveCampaign(); location.reload();">
            üö™ Switch Campaign
          </button>
        `;
      }
    });
  </script>
</body>

</html>