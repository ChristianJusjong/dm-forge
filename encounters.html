<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Encounter Builder - Dungeon Master Forge</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="design-system.css">
  <link rel="stylesheet" href="medieval-theme.css">
  <link rel="stylesheet" href="responsive-design.css">
  <link rel="stylesheet" href="global-overrides.css">
</head>

<body>
  <div id="app">
    <!-- Navigation will be inserted here by nav.js -->

    <!-- Encounter Builder Content -->
    <main class="page-content">
      <div class="page-header">
        <h1 class="page-title">üëπ Encounter Builder</h1>
        <p class="page-subtitle">Design balanced encounters with AI assistance</p>
      </div>

      <button id="new-encounter-btn" class="btn btn-large" style="width: 100%; margin-bottom: 2rem;">+ New
        Encounter</button>

      <div id="encounters-list" class="encounters-grid">
        <!-- Encounters will be rendered here -->
      </div>

      <div id="no-encounters" class="empty-state" style="display: none;">
        <p>No encounters yet. Create your first encounter!</p>
      </div>

      <!-- New Encounter Modal -->
      <div id="new-encounter-modal" class="modal-overlay" style="display: none;">
        <div class="modal large">
          <h3>Create New Encounter</h3>

          <div class="input-group">
            <label class="input-label">Encounter Name</label>
            <input id="new-encounter-name" type="text" placeholder="e.g., Goblin Ambush" class="input">
          </div>

          <div class="input-group">
            <label class="input-label">Description / Setting</label>
            <textarea id="new-encounter-description" placeholder="e.g., Dark forest path at night, fog rolling in..."
              class="textarea" rows="3"></textarea>
          </div>

          <button id="suggest-creatures-btn" class="btn btn-secondary" style="width: 100%; margin-bottom: 1rem;">
            <span id="suggest-btn-text">‚ú® Suggest Creatures (AI)</span>
            <span id="suggest-btn-loading" style="display: none;">‚è≥ Generating suggestions...</span>
          </button>

          <!-- AI Suggestions Area -->
          <div id="ai-suggestions" style="display: none; margin-bottom: 2rem;">
            <div class="card">
              <h4 class="text-gold mb-md">AI Suggestions</h4>
              <div id="suggestions-list" style="display: grid; gap: 0.75rem;">
                <!-- Suggestions will appear here -->
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button id="create-encounter-btn" class="btn">Create Encounter</button>
            <button id="cancel-encounter-btn" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Edit Encounter Modal -->
      <div id="edit-encounter-modal" class="modal-overlay" style="display: none;">
        <div class="modal large">
          <h3><span data-i18n="edit">Edit</span>: <span id="edit-encounter-title"></span></h3>

          <!-- Add Creature Form -->
          <div class="card mb-lg">
            <h4 class="text-gold mb-md">Add Creatures</h4>
            <div class="creature-form-grid">
              <div class="input-group">
                <label class="input-label" data-i18n="creatureName">Creature Name</label>
                <input id="edit-creature-name" type="text" class="input">
              </div>
              <div class="input-group">
                <label class="input-label" data-i18n="hp">HP</label>
                <input id="edit-creature-hp" type="number" value="10" class="input">
              </div>
              <div class="input-group">
                <label class="input-label" data-i18n="ac">AC</label>
                <input id="edit-creature-ac" type="number" value="12" class="input">
              </div>
              <div class="input-group">
                <label class="input-label" data-i18n="cr">CR</label>
                <input id="edit-creature-cr" type="number" value="0.25" step="0.125" class="input">
              </div>
              <div class="input-group">
                <label class="input-label" data-i18n="count">Count</label>
                <input id="edit-creature-count" type="number" value="1" min="1" class="input">
              </div>
              <button id="add-creature-btn" class="btn" style="height: fit-content; align-self: end;"
                data-i18n="add">Add</button>
            </div>
          </div>

          <!-- Creatures List -->
          <div class="card">
            <h4 class="text-gold mb-md">Creatures in Encounter</h4>
            <div id="edit-creatures-list" class="creatures-list">
              <!-- Creatures will be rendered here -->
            </div>
            <div id="no-creatures-in-edit" class="empty-state" style="display: none; padding: 2rem;">
              <p>No creatures yet. Add some above!</p>
            </div>
          </div>

          <div class="modal-actions" style="margin-top: 1.5rem;">
            <button id="save-encounter-btn" class="btn" data-i18n="save">Save Changes</button>
            <button id="close-edit-modal-btn" class="btn btn-secondary" data-i18n="close">Close</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="storage-utils.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="translations.js"></script>
  <script type="module" src="campaign-manager.js"></script>
  <script type="module" src="nav.js"></script>
  <script type="module" src="tutorial.js"></script>
  <script type="module" src="ads.js"></script>
  <script>
    // Wait for modules to load
    window.addEventListener('load', () => {
      // Check Tutorial Prerequisites
      if (typeof checkPrerequisites === 'function') {
        if (!checkPrerequisites('encounters')) {
          return;
        }
      }

      // Require authentication
      if (typeof requireAuth === 'function' && !requireAuth()) {
        throw new Error('Authentication required');
      }
    });

    // ========================================
    // ENCOUNTER BUILDER WITH AI SUGGESTIONS
    // ========================================

    // Groq API key is retrieved from campaign settings via window.getGroqApiKey()
    const USE_GROQ = true; // Using Groq for better performance and no rate limits

    const GEMINI_API_KEY = 'AIzaSyC_FPJb1pVXl4x8_cWd8xX9T-c1z238wiI';
    let encounters = [];
    let currentEditingEncounter = null;

    // ========================================
    // NOTES INTEGRATION
    // ========================================

    function saveToNotes(content, category) {
      const sessions = JSON.parse(localStorage.getItem('session_notes') || '[]');

      if (sessions.length === 0) {
        alert('Please create a session in Notes first!');
        window.location.href = 'notes.html';
        return;
      }

      // Get or create the most recent session
      const currentSession = sessions[0];

      // Find or create appropriate section
      let section = currentSession.sections.find(s =>
        s.title.toLowerCase().includes(category.toLowerCase())
      );

      if (!section) {
        // Create new section
        section = { title: category, content: '' };
        currentSession.sections.push(section);
      }

      // Append content with timestamp
      const timestamp = new Date().toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });

      section.content += (section.content ? '\n\n' : '') + `[${timestamp}]\n${content}`;

      localStorage.setItem('session_notes', JSON.stringify(sessions));
      alert('Saved to Notes!');
    }

    function loadEncounters() {
      encounters = safeLocalStorageGet('encounters', []);
    }

    function saveEncounters() {
      if (!safeLocalStorageSet('encounters', encounters)) {
        alert('Failed to save encounter! Storage might be full.');
      }
    }

    function getPartyInfo() {
      const party = safeLocalStorageGet('party_members', []);
      if (party.length === 0) return null;

      const avgLevel = party.reduce((sum, char) => sum + char.level, 0) / party.length;
      return {
        size: party.length,
        avgLevel: Math.round(avgLevel),
        members: party
      };
    }

    async function generateWithGroq(prompt) {
      // Check for API key
      const apiKey = typeof window.getGroqApiKey === 'function' ? window.getGroqApiKey() : null;

      if (!apiKey) {
        alert('‚ö†Ô∏è Groq API Key Required\n\nTo use AI features, please add your free Groq API key in:\nConfiguration > AI Settings\n\nClick OK to go to Configuration now.');
        window.location.href = 'configuration.html';
        return;
      }

      const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'llama-3.1-8b-instant',
          messages: [{ role: 'user', content: prompt }],
          temperature: 0.7,
          max_tokens: 800
        })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(`Groq API: ${error.error?.message || response.statusText}`);
      }

      const data = await response.json();
      return data.choices[0].message.content;
    }

    async function generateWithGemini(prompt) {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-lite:generateContent`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-goog-api-key': GEMINI_API_KEY
        },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }]
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        if (response.status === 503) {
          throw new Error('Google Gemini server is overloaded right now. Please try again in a moment.');
        } else if (response.status === 429) {
          throw new Error('Too many requests. Please wait a minute and try again.');
        } else {
          throw new Error(`API error ${response.status}`);
        }
      }

      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    }

    async function suggestCreatures() {
      const description = document.getElementById('new-encounter-description').value.trim();

      if (!description) {
        alert('Please enter a description first!');
        return;
      }

      // Show loading state
      document.getElementById('suggest-btn-text').style.display = 'none';
      document.getElementById('suggest-btn-loading').style.display = 'inline';
      document.getElementById('suggest-creatures-btn').disabled = true;

      try {
        const partyInfo = getPartyInfo();
        const partyContext = partyInfo
          ? `The party has ${partyInfo.size} members at average level ${partyInfo.avgLevel}.`
          : 'Party size and level unknown.';

        const prompt = `D&D 5e encounter. ${partyContext}

Setting: "${description}"

Return ONLY valid JSON with backstory and 3-4 creatures/NPCs/groups. Mix hostile & peaceful.

Format (exact):
{
  "backstory": "Short backstory in ENGLISH about why this encounter is happening (2-3 sentences)",
  "purpose": "The main purpose/goal of this encounter in ENGLISH (1 sentence)",
  "creatures": [
    {
      "name": "Merchant Caravan",
      "individualName": "Boris Ironfoot",
      "hp": 15,
      "ac": 12,
      "cr": 0.5,
      "description": "A stout dwarf merchant with a golden beard and nervous hand gestures. Leading a caravan of traders heading to town with expensive silks and spices.",
      "count": 1
    }
  ]
}

IMPORTANT:
- Return ONLY JSON object, no other text
- "backstory" and "purpose" in ENGLISH
- "description" field in ENGLISH with: personality, appearance, quirks, what they're doing, hostile/peaceful
- "individualName" should be a specific character name in ENGLISH
- Keep "name" as creature type in English
- Use double quotes only
- Include "count" field (default 1)`;

        let text;

        // Get API key
        const apiKey = typeof window.getGroqApiKey === 'function' ? window.getGroqApiKey() : null;

        // Try Groq first if enabled (faster, much higher rate limits)
        if (USE_GROQ && apiKey) {
          try {
            text = await generateWithGroq(prompt);
            console.log('‚úÖ Generated with Groq (fast & unlimited)');
          } catch (groqError) {
            console.warn('‚ö†Ô∏è Groq failed, using Gemini:', groqError.message);
            text = await generateWithGemini(prompt);
            console.log('‚úÖ Generated with Gemini (fallback)');
          }
        } else {
          // Use Gemini by default
          console.log('‚ÑπÔ∏è Using Gemini (no Groq API key)');
          text = await generateWithGemini(prompt);
          console.log('‚úÖ Generated with Gemini');
        }

        // Extract JSON from response (now looking for object instead of array)
        const jsonMatch = text.match(/\{[\s\S]*\}/);
        if (!jsonMatch) {
          console.error('Could not find JSON in response:', text);
          throw new Error('Could not parse AI response. The AI may have returned text instead of JSON.');
        }

        // Clean and fix common JSON formatting issues
        let jsonString = jsonMatch[0]
          .replace(/```json\s*/g, '')  // Remove markdown code blocks
          .replace(/```\s*/g, '')
          .replace(/,\s*([\]}])/g, '$1')  // Remove trailing commas
          .trim();

        console.log('Extracted JSON:', jsonString);

        let encounterData;
        try {
          encounterData = JSON.parse(jsonString);
        } catch (parseError) {
          console.error('JSON Parse Error:', parseError);
          console.error('Failed JSON string:', jsonString);
          throw new Error('AI returned invalid JSON. Please try again.');
        }

        // Validate encounter data
        if (!encounterData.creatures || !Array.isArray(encounterData.creatures) || encounterData.creatures.length === 0) {
          throw new Error('AI returned invalid encounter format');
        }

        // Translate backstory and purpose if Danish
        let backstory = encounterData.backstory || '';
        let purpose = encounterData.purpose || '';

        if (getCurrentLanguage() === 'da') {
          if (backstory) backstory = await translateWithGroq(backstory, 'da');
          if (purpose) purpose = await translateWithGroq(purpose, 'da');
        }

        // Store backstory and purpose for later use
        window.encounterBackstory = backstory;
        window.encounterPurpose = purpose;

        displaySuggestions(encounterData.creatures, backstory, purpose);

      } catch (error) {
        console.error('AI Error:', error);
        alert(`Could not generate suggestions:\n\n${error.message}\n\nPlease try again in a moment.`);
      } finally {
        // Reset button state
        document.getElementById('suggest-btn-text').style.display = 'inline';
        document.getElementById('suggest-btn-loading').style.display = 'none';
        document.getElementById('suggest-creatures-btn').disabled = false;
      }
    }

    function displaySuggestions(suggestions, backstory, purpose) {
      const container = document.getElementById('suggestions-list');
      const aiSuggestions = document.getElementById('ai-suggestions');

      let html = '';

      // Display backstory and purpose
      if (backstory || purpose) {
        html += `
          <div class="card" style="padding: 1rem; background: linear-gradient(135deg, var(--parchment-dark) 0%, var(--parchment) 100%); border-left: 4px solid var(--gold);">
            ${backstory ? `
              <div style="margin-bottom: 0.75rem;">
                <strong style="color: var(--wood-brown); display: block; margin-bottom: 0.25rem;">üìñ Backstory:</strong>
                <p style="color: var(--color-text-primary); margin: 0; line-height: 1.5;">${backstory}</p>
              </div>
            ` : ''}
            ${purpose ? `
              <div>
                <strong style="color: var(--wood-brown); display: block; margin-bottom: 0.25rem;">üéØ Purpose:</strong>
                <p style="color: var(--color-text-primary); margin: 0; line-height: 1.5;">${purpose}</p>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Display creatures
      html += suggestions.map((creature, index) => `
        <div class="card" style="padding: 1rem;">
          <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
            <div style="flex: 1;">
              <h5 style="color: var(--wood-brown); margin-bottom: 0.25rem;">${creature.name}${creature.individualName ? ` - ${creature.individualName}` : ''}</h5>
              ${creature.description ? `<p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem; line-height: 1.4;">${creature.description}</p>` : ''}
              <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem;">
                <span><strong>HP:</strong> ${creature.hp}</span>
                <span><strong>AC:</strong> ${creature.ac}</span>
                <span><strong>CR:</strong> ${creature.cr}</span>
                ${creature.count > 1 ? `<span><strong>Count:</strong> ${creature.count}</span>` : ''}
              </div>
            </div>
            <button class="btn-small use-suggestion" data-index="${index}">Brug Denne</button>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
      aiSuggestions.style.display = 'block';

      // Add event listeners
      document.querySelectorAll('.use-suggestion').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          const creature = suggestions[index];

          // Fill in the creature in the encounter (will be added when created)
          if (!window.pendingCreatures) window.pendingCreatures = [];
          window.pendingCreatures.push({
            ...creature,
            count: 1 // Default count
          });

          e.target.textContent = '‚úì Added';
          e.target.disabled = true;
          e.target.classList.add('btn-secondary');
        });
      });
    }

    function renderEncounters() {
      const list = document.getElementById('encounters-list');
      const noEncounters = document.getElementById('no-encounters');

      if (encounters.length === 0) {
        list.innerHTML = '';
        noEncounters.style.display = 'block';
        return;
      }

      noEncounters.style.display = 'none';

      list.innerHTML = encounters.map(encounter => {
        const totalCR = encounter.creatures.reduce((sum, c) => sum + (parseFloat(c.cr) || 0), 0).toFixed(2);
        const totalCreatures = encounter.creatures.reduce((sum, c) => sum + (c.count || 1), 0);

        return `
          <div class="encounter-card">
            <div class="encounter-header">
              <div>
                <h3>${encounter.name}</h3>
                ${encounter.description ? `<p style="color: var(--text-secondary); margin-top: 0.5rem;">${encounter.description}</p>` : ''}
              </div>
              <div style="display: flex; gap: 0.5rem;">
                <button class="btn-small edit-encounter-btn" data-id="${encounter.id}">${t('edit')}</button>
                <button class="btn-small btn-danger delete-encounter-btn" data-id="${encounter.id}">√ó</button>
              </div>
            </div>

            ${encounter.backstory || encounter.purpose ? `
              <div style="margin-top: 1rem; padding: 1rem; background: linear-gradient(135deg, var(--parchment-dark) 0%, var(--parchment) 100%); border-radius: 8px; border-left: 4px solid var(--gold);">
                ${encounter.backstory ? `
                  <div style="margin-bottom: ${encounter.purpose ? '0.75rem' : '0'};">
                    <strong style="color: var(--wood-brown); display: block; margin-bottom: 0.25rem;">üìñ Backstory:</strong>
                    <p style="color: var(--color-text-primary); margin: 0; font-size: 0.95rem; line-height: 1.5;">${encounter.backstory}</p>
                  </div>
                ` : ''}
                ${encounter.purpose ? `
                  <div>
                    <strong style="color: var(--wood-brown); display: block; margin-bottom: 0.25rem;">üéØ Purpose:</strong>
                    <p style="color: var(--color-text-primary); margin: 0; font-size: 0.95rem; line-height: 1.5;">${encounter.purpose}</p>
                  </div>
                ` : ''}
              </div>
            ` : ''}

            ${encounter.creatures.length > 0 ? `
              <div class="creatures-list" style="margin-top: 1rem;">
                ${encounter.creatures.map(creature => `
                  <div class="creature-item">
                    <div>
                      <strong>${creature.count > 1 ? creature.count + 'x ' : ''}${creature.name}${creature.individualName ? ` - ${creature.individualName}` : ''}</strong>
                      ${creature.description ? `<div style="color: var(--text-secondary); margin-top: 0.25rem; font-size: 0.9rem; line-height: 1.4;">${creature.description}</div>` : ''}
                      <span style="color: var(--text-secondary); margin-left: ${creature.description ? '0' : '1rem'}; display: ${creature.description ? 'block' : 'inline'}; margin-top: ${creature.description ? '0.5rem' : '0'};">
                        HP: ${creature.hp} | AC: ${creature.ac} | CR: ${creature.cr}
                      </span>
                    </div>
                  </div>
                `).join('')}
              </div>

              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding-top: 1rem; border-top: 2px solid var(--gold);">
                <div style="display: flex; gap: 2rem;">
                  <span><strong>Total Creatures:</strong> ${totalCreatures}</span>
                  <span><strong>Total CR:</strong> ${totalCR}</span>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <button class="btn btn-secondary save-encounter-notes-btn" data-id="${encounter.id}">üìù Save to Notes</button>
                  <button class="btn load-encounter-btn" data-id="${encounter.id}">${t('loadToInitiative')}</button>
                </div>
              </div>
            ` : '<p style="color: var(--text-secondary); margin-top: 1rem;">No creatures added yet</p>'}
          </div>
        `;
      }).join('');

      // Event listeners
      document.querySelectorAll('.edit-encounter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.dataset.id);
          editEncounter(id);
        });
      });

      document.querySelectorAll('.delete-encounter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (confirm(t('deleteEncounterConfirm'))) {
            const id = parseInt(e.target.dataset.id);
            encounters = encounters.filter(enc => enc.id !== id);
            saveEncounters();
            renderEncounters();
          }
        });
      });

      document.querySelectorAll('.load-encounter-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.dataset.id);
          loadEncounterToInitiative(id);
        });
      });

      document.querySelectorAll('.save-encounter-notes-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = parseInt(e.target.dataset.id);
          const encounter = encounters.find(enc => enc.id === id);
          if (encounter) {
            let content = `Encounter: ${encounter.name}\n`;
            if (encounter.description) {
              content += `Description: ${encounter.description}\n`;
            }
            if (encounter.backstory) {
              content += `\nBackstory: ${encounter.backstory}\n`;
            }
            if (encounter.purpose) {
              content += `Purpose: ${encounter.purpose}\n`;
            }
            content += `\nCreatures:\n`;
            encounter.creatures.forEach(c => {
              content += `- ${c.count > 1 ? c.count + 'x ' : ''}${c.name}${c.individualName ? ` (${c.individualName})` : ''} (HP: ${c.hp}, AC: ${c.ac}, CR: ${c.cr})\n`;
              if (c.description) {
                content += `  ${c.description}\n`;
              }
            });
            saveToNotes(content, 'Events');
          }
        });
      });
    }

    function loadEncounterToInitiative(encounterId) {
      const encounter = encounters.find(enc => enc.id === encounterId);
      if (!encounter || encounter.creatures.length === 0) return;

      const initiativeData = localStorage.getItem('initiative_tracker');
      let data = initiativeData ? JSON.parse(initiativeData) : { combatants: [], round: 1, currentTurn: 0 };

      let idCounter = Date.now();
      encounter.creatures.forEach(creature => {
        const count = creature.count || 1;
        for (let i = 0; i < count; i++) {
          data.combatants.push({
            id: idCounter++,
            name: count > 1 ? `${creature.name} ${i + 1}` : creature.name,
            initiative: 10,
            hp: creature.hp,
            maxHp: creature.hp,
            ac: creature.ac,
            cr: creature.cr || 0,
            description: creature.reason || '',
            conditions: []
          });
        }
      });

      localStorage.setItem('initiative_tracker', JSON.stringify(data));

      const totalCreatures = encounter.creatures.reduce((sum, c) => sum + (c.count || 1), 0);
      if (confirm(`${totalCreatures} creatures indl√¶st! G√• til Initiativ Tracker?`)) {
        window.location.href = 'initiative.html';
      }
    }

    function editEncounter(encounterId) {
      currentEditingEncounter = encounters.find(enc => enc.id === encounterId);
      if (!currentEditingEncounter) return;

      document.getElementById('edit-encounter-title').textContent = currentEditingEncounter.name;
      document.getElementById('edit-encounter-modal').style.display = 'flex';
      renderEditCreatures();
    }

    function renderEditCreatures() {
      if (!currentEditingEncounter) return;

      const list = document.getElementById('edit-creatures-list');
      const noCreatures = document.getElementById('no-creatures-in-edit');

      if (currentEditingEncounter.creatures.length === 0) {
        list.innerHTML = '';
        noCreatures.style.display = 'block';
        return;
      }

      noCreatures.style.display = 'none';

      list.innerHTML = currentEditingEncounter.creatures.map((creature, index) => `
        <div class="creature-item">
          <div>
            <strong>${creature.count > 1 ? creature.count + 'x ' : ''}${creature.name}</strong>
            <span style="color: var(--text-secondary); margin-left: 1rem;">
              HP: ${creature.hp} | AC: ${creature.ac} | CR: ${creature.cr}
            </span>
          </div>
          <button class="btn-small btn-danger remove-creature-btn" data-index="${index}">Remove</button>
        </div>
      `).join('');

      // Event listeners
      document.querySelectorAll('.remove-creature-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const index = parseInt(e.target.dataset.index);
          currentEditingEncounter.creatures.splice(index, 1);
          renderEditCreatures();
        });
      });
    }

    function addCreatureToEdit() {
      if (!currentEditingEncounter) return;

      const name = document.getElementById('edit-creature-name').value.trim();
      const hp = parseInt(document.getElementById('edit-creature-hp').value);
      const ac = parseInt(document.getElementById('edit-creature-ac').value);
      const cr = parseFloat(document.getElementById('edit-creature-cr').value);
      const count = parseInt(document.getElementById('edit-creature-count').value);

      if (!name || isNaN(hp) || isNaN(ac) || isNaN(cr)) {
        alert('Please fill out all fields!');
        return;
      }

      currentEditingEncounter.creatures.push({ name, hp, ac, cr, count });

      // Clear form
      document.getElementById('edit-creature-name').value = '';
      document.getElementById('edit-creature-hp').value = '10';
      document.getElementById('edit-creature-ac').value = '12';
      document.getElementById('edit-creature-cr').value = '0.25';
      document.getElementById('edit-creature-count').value = '1';

      renderEditCreatures();
    }

    function saveEditedEncounter() {
      if (!currentEditingEncounter) return;

      saveEncounters();
      renderEncounters();

      document.getElementById('edit-encounter-modal').style.display = 'none';
      currentEditingEncounter = null;
    }

    function showNewEncounterModal() {
      document.getElementById('new-encounter-modal').style.display = 'flex';
      document.getElementById('ai-suggestions').style.display = 'none';
      window.pendingCreatures = [];
    }

    function hideNewEncounterModal() {
      document.getElementById('new-encounter-modal').style.display = 'none';
      document.getElementById('new-encounter-name').value = '';
      document.getElementById('new-encounter-description').value = '';
      document.getElementById('ai-suggestions').style.display = 'none';
      window.pendingCreatures = [];
    }

    function createEncounter() {
      try {
        const nameInput = document.getElementById('new-encounter-name');
        const descInput = document.getElementById('new-encounter-description');

        const name = nameInput.value.trim();
        const description = descInput.value.trim();

        if (!name) {
          alert('Please enter an encounter name!');
          nameInput.focus();
          return;
        }

        const newEncounter = {
          id: Date.now(),
          name,
          description,
          backstory: window.encounterBackstory || '',
          purpose: window.encounterPurpose || '',
          creatures: window.pendingCreatures || []
        };

        encounters.unshift(newEncounter);
        saveEncounters();
        renderEncounters();
        hideNewEncounterModal();

        // Reset inputs explicitly
        nameInput.value = '';
        descInput.value = '';
        window.pendingCreatures = [];

      } catch (error) {
        console.error('Error creating encounter:', error);
        alert('An error occurred while creating the encounter.');
      }
    }

    // Event listeners
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('new-encounter-btn').addEventListener('click', showNewEncounterModal);
      document.getElementById('cancel-encounter-btn').addEventListener('click', hideNewEncounterModal);
      document.getElementById('create-encounter-btn').addEventListener('click', createEncounter);
      document.getElementById('suggest-creatures-btn').addEventListener('click', suggestCreatures);

      document.getElementById('add-creature-btn').addEventListener('click', addCreatureToEdit);
      document.getElementById('save-encounter-btn').addEventListener('click', saveEditedEncounter);
      document.getElementById('close-edit-modal-btn').addEventListener('click', () => {
        document.getElementById('edit-encounter-modal').style.display = 'none';
        currentEditingEncounter = null;
      });

      // Close modals on overlay click
      document.getElementById('new-encounter-modal').addEventListener('click', (e) => {
        if (e.target.id === 'new-encounter-modal') hideNewEncounterModal();
      });
      document.getElementById('edit-encounter-modal').addEventListener('click', (e) => {
        if (e.target.id === 'edit-encounter-modal') {
          document.getElementById('edit-encounter-modal').style.display = 'none';
          currentEditingEncounter = null;
        }
      });

      loadEncounters();
      renderEncounters();
    });
  </script>
</body>

</html>