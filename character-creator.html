<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Forge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="medieval-theme.css">
    <link rel="stylesheet" href="player-app.css">
</head>

<body>
    <div id="app">
        <!-- Nav inserted by script -->

        <main class="player-layout">
            <h1 class="page-title" style="text-align: center; margin-bottom: 2rem;">‚öîÔ∏è Character Forge</h1>

            <div class="wizard-container">
                <div class="wizard-steps">
                    <div class="step-indicator active" data-step="1">1</div>
                    <div class="step-indicator" data-step="2">2</div>
                    <div class="step-indicator" data-step="3">3</div>
                    <div class="step-indicator" data-step="4">‚úì</div>
                </div>

                <form id="creator-form">
                    <!-- Step 1: Basics -->
                    <div class="wizard-step" data-step="1">
                        <h2>Step 1: The Foundation</h2>
                        <div class="input-group">
                            <label class="input-label">Character Name</label>
                            <input type="text" name="name" class="input" required placeholder="Ex: Valen Shadowheart">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Race</label>
                                <select name="race" class="input">
                                    <option value="Human">Human</option>
                                    <option value="Elf">Elf</option>
                                    <option value="Dwarf">Dwarf</option>
                                    <option value="Halfling">Halfling</option>
                                    <option value="Dragonborn">Dragonborn</option>
                                    <option value="Tiefling">Tiefling</option>
                                    <option value="Gnome">Gnome</option>
                                    <option value="Half-Elf">Half-Elf</option>
                                    <option value="Half-Orc">Half-Orc</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Class</label>
                                <select name="class" class="input">
                                    <option value="Fighter">Fighter</option>
                                    <option value="Wizard">Wizard</option>
                                    <option value="Rogue">Rogue</option>
                                    <option value="Cleric">Cleric</option>
                                    <option value="Barbarian">Barbarian</option>
                                    <option value="Bard">Bard</option>
                                    <option value="Druid">Druid</option>
                                    <option value="Monk">Monk</option>
                                    <option value="Paladin">Paladin</option>
                                    <option value="Ranger">Ranger</option>
                                    <option value="Sorcerer">Sorcerer</option>
                                    <option value="Warlock">Warlock</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Ability Scores -->
                    <div class="wizard-step" data-step="2" style="display: none;">
                        <h2>Step 2: Ability Scores</h2>
                        <p class="text-sm" style="color: var(--text-muted); margin-bottom: 1rem;">Assign your core
                            attributes.</p>

                        <div class="ability-scores-grid">
                            <!-- Generated by JS -->
                        </div>

                        <div style="text-align: center;">
                            <button type="button" id="roll-stats-btn" class="btn btn-secondary">üé≤ Roll Stats (4d6 drop
                                low)</button>
                            <button type="button" id="std-array-btn" class="btn btn-secondary">Standard Array</button>
                        </div>
                    </div>

                    <!-- Step 3: Background & Details -->
                    <div class="wizard-step" data-step="3" style="display: none;">
                        <h2>Step 3: Background & Vitals</h2>

                        <div class="input-group">
                            <label class="input-label">Background</label>
                            <input type="text" name="background" class="input"
                                placeholder="Ex: Soldier, Criminal, Sage">
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="input-group">
                                <label class="input-label">Max HP</label>
                                <input type="number" name="maxHp" class="input" value="10">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Armor Class (AC)</label>
                                <input type="number" name="ac" class="input" value="10">
                            </div>
                        </div>

                        <div class="input-group">
                            <label class="input-label">Alignment</label>
                            <select name="alignment" class="input">
                                <option value="True Neutral">True Neutral</option>
                                <option value="Chaotic Neutral">Chaotic Neutral</option>
                                <option value="Lawful Good">Lawful Good</option>
                                <option value="Chaotic Evil">Chaotic Evil</option>
                                <!-- etc -->
                            </select>
                        </div>
                    </div>

                    <!-- Step 4: Finalize -->
                    <div class="wizard-step" data-step="4" style="display: none;">
                        <h2>Step 4: Ready to Adventure?</h2>
                        <div class="input-group">
                            <label class="input-label">Starting Gold</label>
                            <input type="number" name="gold" class="input" value="10">
                        </div>
                        <p>Your character is ready to be forged. Click 'Finish' to save and view your sheet.</p>
                    </div>

                    <!-- Controls -->
                    <div style="margin-top: 2rem; display: flex; justify-content: space-between;">
                        <button type="button" id="prev-btn" class="btn btn-secondary"
                            style="visibility: hidden;">Back</button>
                        <button type="button" id="next-btn" class="btn btn-primary">Next</button>
                        <button type="submit" id="finish-btn" class="btn btn-primary" style="display: none;">üéâ
                            Finish</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module" src="nav.js"></script>
    <script src="auth.js"></script>
    <script type="module">
        import { Character } from './character-model.js';

        // Auth Check
        if (!isLoggedIn()) {
            window.location.href = 'login.html?redirect=character-creator.html';
        }
        const currentUser = getCurrentUser();

        // Wizard State
        let currentStep = 1;
        const totalSteps = 4;

        // DOM Elements
        const form = document.getElementById('creator-form');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const finishBtn = document.getElementById('finish-btn');
        const steps = document.querySelectorAll('.wizard-step');
        const indicators = document.querySelectorAll('.step-indicator');

        // Init Step 2 UI
        const abilities = ['STR', 'DEX', 'CON', 'INT', 'WIS', 'CHA'];
        const abilityGrid = document.querySelector('.ability-scores-grid');

        abilities.forEach(stat => {
            abilityGrid.innerHTML += `
                <div class="ability-card" style="width: 100px;"> 
                    <label class="text-sm">${stat}</label>
                    <input type="number" name="stat_${stat.toLowerCase()}" class="input" style="text-align: center; font-size: 1.2rem;" value="10" min="1" max="20">
                </div>
            `;
        });


        let charData = {
            name: '', race: '', class: '', level: 1,
            stats: { STR: 10, DEX: 10, CON: 10, INT: 10, WIS: 10, CHA: 10 },
            background: '', alignment: '',
            hp: { current: 10, max: 10, temp: 0 },
            ac: 10,
            speed: 30
        };

        // Expose wizard controls
        window.nextStep = () => {
            if (!validateStep(currentStep)) return;
            if (currentStep < totalSteps) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                updateProgress();
            }
        };

        window.prevStep = () => {
            if (currentStep > 1) {
                document.getElementById(`step-${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step-${currentStep}`).classList.add('active');
                updateProgress();
            }
        };

        window.finish = () => {
            // Collect final data
            charData.name = document.getElementById('char-name').value;
            charData.race = document.getElementById('char-race').value;
            charData.class = document.getElementById('char-class').value;

            // Stats
            ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
                charData.stats[stat.toUpperCase()] = parseInt(document.getElementById(`score-${stat}`).value) || 10;
            });

            charData.background = document.getElementById('char-background').value;
            charData.alignment = document.getElementById('char-alignment').value;
            charData.hp.max = parseInt(document.getElementById('char-hp').value) || 10;
            charData.hp.current = charData.hp.max;
            charData.ac = parseInt(document.getElementById('char-ac').value) || 10;

            const newChar = new Character(charData);
            // Save to LocalStorage
            const saved = JSON.parse(localStorage.getItem('player_characters') || '[]');
            saved.push(newChar);
            localStorage.setItem('player_characters', JSON.stringify(saved));

            // Redirect
            window.location.href = 'player-dashboard.html';
        });

        updateUI();
    </script>
</body>

</html>