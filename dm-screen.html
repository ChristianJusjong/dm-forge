<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D&D Dungeon Master Screen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Lato:wght@300;400;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="dm-screen.css">
  <link rel="manifest" href="manifest.json">
</head>

<body>
  <div id="app">
    <!-- Header -->
    <header class="app-header">
      <h1>‚öîÔ∏è Dungeon Master Screen</h1>
      <div class="header-controls">
        <div class="language-selector">
          <label for="language">üåç</label>
          <select id="language" class="input">
            <option value="en">English</option>
            <option value="da">Dansk</option>
          </select>
        </div>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button class="tab-button active" data-tab="initiative">
        <span class="tab-icon">‚öîÔ∏è</span>
        <span class="tab-label" data-i18n="initiative">Initiative</span>
      </button>
      <button class="tab-button" data-tab="encounters">
        <span class="tab-icon">üëπ</span>
        <span class="tab-label" data-i18n="encounters">Encounters</span>
      </button>
      <button class="tab-button" data-tab="monsters">
        <span class="tab-icon">üêâ</span>
        <span class="tab-label" data-i18n="monsters">Monsters</span>
      </button>
      <button class="tab-button" data-tab="npcs">
        <span class="tab-icon">üßô</span>
        <span class="tab-label" data-i18n="npcs">NPCs</span>
      </button>
      <button class="tab-button" data-tab="inspiration">
        <span class="tab-icon">‚ú®</span>
        <span class="tab-label" data-i18n="inspiration">Inspiration</span>
      </button>
      <button class="tab-button" data-tab="notes">
        <span class="tab-icon">üìù</span>
        <span class="tab-label" data-i18n="notes">Notes</span>
      </button>
      <button class="tab-button" data-tab="players">
        <span class="tab-icon">üë•</span>
        <span class="tab-label">Players</span>
      </button>
    </nav>

    <!-- Tab Content Container -->
    <main class="tab-content">

      <!-- Live Players Tab -->
      <div id="tab-players" class="tab-pane">
        <div class="initiative-tracker">
          <div class="tracker-header">
            <h2>üë• Live Party Dashboard</h2>
            <div class="combat-info">
              <span style="font-size: 0.9rem; opacity: 0.8;">Campaign Code: <strong id="display-campaign-code"
                  style="color: var(--primary-gold); font-family: monospace; font-size: 1.2rem;">LOADING...</strong></span>
            </div>
          </div>

          <div id="live-party-list" class="encounters-list" style="margin-top: 1rem;">
            <!-- Live Players Rendered Here -->
          </div>

          <div id="no-players" class="empty-state">
            <p>Waiting for heroes to join...</p>
            <small style="opacity: 0.6;">Share the Campaign Code with your players.</small>
          </div>
        </div>
      </div>

      <!-- Initiative Tracker Tab -->
      <div id="tab-initiative" class="tab-pane active">
        <div class="initiative-tracker">
          <div class="tracker-header">
            <h2>‚öîÔ∏è <span data-i18n="initiativeTracker">Initiative Tracker</span></h2>
            <div class="combat-info">
              <span><span data-i18n="round">Round</span>: <span id="round-number">1</span></span>
              <button id="next-turn-btn" class="btn" data-i18n="nextTurn">Next Turn</button>
              <button id="reset-combat-btn" class="btn btn-secondary" data-i18n="resetCombat">Reset Combat</button>
            </div>
          </div>

          <!-- Add Combatant Form -->
          <div class="add-combatant-form">
            <div class="input-wrapper">
              <label for="combatant-name" data-i18n="characterName">Character Name</label>
              <input id="combatant-name" type="text" placeholder="" class="input">
            </div>
            <div class="input-wrapper">
              <label for="combatant-initiative" data-i18n="initiative">Initiative</label>
              <input id="combatant-initiative" type="number" placeholder="" class="input">
            </div>
            <div class="input-wrapper">
              <label for="combatant-hp" data-i18n="hp">HP</label>
              <input id="combatant-hp" type="number" placeholder="" class="input">
            </div>
            <div class="input-wrapper">
              <label for="combatant-ac" data-i18n="ac">AC</label>
              <input id="combatant-ac" type="number" placeholder="" class="input">
            </div>
            <button id="add-combatant-btn" class="btn" data-i18n="addCombatant">Add</button>
          </div>

          <!-- Combatants List -->
          <div id="combatants-list" class="combatants-list">
            <!-- Combatants will be rendered here -->
          </div>

          <div id="no-combatants" class="empty-state" style="display: none;">
            <p data-i18n="noCombatants">No combatants in initiative order</p>
          </div>
        </div>
      </div>

      <!-- Encounter Builder Tab -->
      <div id="tab-encounters" class="tab-pane">
        <div class="encounter-builder">
          <div class="encounter-header">
            <h2>üëπ <span data-i18n="encounterBuilder">Encounter Builder</span></h2>
            <button id="new-encounter-btn" class="btn" data-i18n="newEncounter">+ New Encounter</button>
          </div>

          <div id="encounters-list" class="encounters-list">
            <!-- Encounters will be rendered here -->
          </div>

          <div id="no-encounters" class="empty-state" style="display: none;">
            <p data-i18n="noEncounters">No encounters created yet</p>
          </div>
        </div>

        <!-- New Encounter Modal -->
        <div id="new-encounter-modal" class="modal-overlay" style="display: none;">
          <div class="modal">
            <h3 data-i18n="createNewEncounter">Create New Encounter</h3>
            <input id="new-encounter-name" type="text" data-i18n-placeholder="encounterName"
              placeholder="Encounter Name" class="input">
            <textarea id="new-encounter-description" data-i18n-placeholder="descriptionOptional"
              placeholder="Description (optional)" class="textarea" rows="3"></textarea>
            <div class="modal-actions">
              <button id="create-encounter-btn" class="btn" data-i18n="create">Create</button>
              <button id="cancel-encounter-btn" class="btn btn-secondary" data-i18n="cancel">Cancel</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Monsters Tab -->
      <div id="tab-monsters" class="tab-pane">
        <div class="monster-browser">
          <div class="monster-header">
            <h2>üêâ <span data-i18n="monsterBrowser">Monster Browser</span></h2>
            <p class="subtitle">Powered by Open5e (SRD) + D&D Beyond Links</p>
          </div>

          <!-- Search Bar -->
          <div class="monster-search">
            <div class="input-wrapper">
              <label for="monster-search-input" data-i18n="searchMonsters">Search Monsters</label>
              <input id="monster-search-input" type="text" placeholder="e.g., goblin, dragon..." class="input">
            </div>
            <button id="search-monsters-btn" class="btn" data-i18n="search">Search</button>
          </div>

          <!-- Loading indicator -->
          <div id="monsters-loading" class="loading" style="display: none;">
            <p>Loading monsters...</p>
          </div>

          <!-- Monsters List -->
          <div id="monsters-list" class="monsters-list">
            <!-- Monsters will be rendered here -->
          </div>

          <div id="no-monsters" class="empty-state" style="display: none;">
            <p data-i18n="noMonstersFound">No monsters found. Try a different search!</p>
          </div>
        </div>

        <!-- Monster Details Modal -->
        <div id="monster-details-modal" class="modal-overlay" style="display: none;">
          <div class="modal large">
            <div id="monster-details-content">
              <!-- Monster details will be rendered here -->
            </div>
            <div class="modal-actions">
              <button id="add-monster-to-encounter-btn" class="btn" data-i18n="addToEncounter">Add to Current
                Encounter</button>
              <button id="close-monster-modal-btn" class="btn btn-secondary" data-i18n="close">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- NPC Generator Tab -->
      <div id="tab-npcs" class="tab-pane">
        <div class="npc-generator">
          <div class="generator-header">
            <h2>üßô <span data-i18n="npcGenerator">NPC Generator</span></h2>
          </div>

          <div class="generator-form">
            <div class="form-group">
              <label data-i18n="npcType">NPC Type</label>
              <input id="npc-prompt" type="text" data-i18n-placeholder="npcTypePlaceholder"
                placeholder="e.g., tavern keeper, mysterious wizard..." class="input">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label data-i18n="race">Race</label>
                <select id="npc-race" class="input">
                  <option value="">Any</option>
                  <option value="Human">Human</option>
                  <option value="Elf">Elf</option>
                  <option value="Dwarf">Dwarf</option>
                  <option value="Halfling">Halfling</option>
                  <option value="Dragonborn">Dragonborn</option>
                  <option value="Gnome">Gnome</option>
                  <option value="Half-Elf">Half-Elf</option>
                  <option value="Half-Orc">Half-Orc</option>
                  <option value="Tiefling">Tiefling</option>
                </select>
              </div>

              <div class="form-group">
                <label data-i18n="setting">Setting</label>
                <input id="npc-setting" type="text" data-i18n-placeholder="settingPlaceholder"
                  placeholder="e.g., medieval city, frontier town..." class="input">
              </div>
            </div>

            <button id="generate-npc-btn" class="btn btn-large" data-i18n="generateNPC">Generate NPC</button>
          </div>

          <!-- Generated NPC Display -->
          <div id="generated-npc-display" class="npc-display" style="display: none;">
            <div class="npc-header">
              <h3 id="generated-npc-name"></h3>
              <button id="save-npc-btn" class="btn-small" data-i18n="saveNPC">Save NPC</button>
            </div>
            <div id="generated-npc-content" class="npc-content"></div>
          </div>

          <div id="npc-error" class="error-message" style="display: none;"></div>

          <!-- Saved NPCs -->
          <div id="saved-npcs-section" class="saved-npcs" style="display: none;">
            <h3 data-i18n="savedNPCs">Saved NPCs</h3>
            <div id="saved-npcs-grid" class="npcs-grid">
              <!-- Saved NPCs will be rendered here -->
            </div>
          </div>
        </div>

        <!-- View NPC Modal -->
        <div id="view-npc-modal" class="modal-overlay" style="display: none;">
          <div class="modal large">
            <h3 id="viewing-npc-name"></h3>
            <div id="viewing-npc-content" class="npc-content"></div>
            <button id="close-npc-modal-btn" class="btn" data-i18n="close">Close</button>
          </div>
        </div>
      </div>

      <!-- Random Tables / Inspiration Tab -->
      <div id="tab-inspiration" class="tab-pane">
        <div class="random-tables">
          <h2>‚ú® <span data-i18n="randomTables">Random Tables</span></h2>

          <div class="generators-grid">
            <!-- NPC Names -->
            <div class="generator-card">
              <h3 data-i18n="npcNames">NPC Names</h3>
              <select id="name-type" class="input">
                <option value="human" data-i18n="human">Human</option>
                <option value="elf" data-i18n="elf">Elf</option>
                <option value="dwarf" data-i18n="dwarf">Dwarf</option>
                <option value="halfling" data-i18n="halfling">Halfling</option>
                <option value="orc" data-i18n="orc">Orc</option>
              </select>
              <button class="btn generate-name-btn" data-i18n="generate">Generate</button>
              <div class="result name-result"></div>
            </div>

            <!-- Tavern Names -->
            <div class="generator-card">
              <h3 data-i18n="tavernNames">Tavern Names</h3>
              <select id="tavern-type" class="input">
                <option value="tavern" data-i18n="tavern">Tavern</option>
                <option value="shop" data-i18n="shop">Shop</option>
                <option value="inn" data-i18n="inn">Inn</option>
              </select>
              <button class="btn generate-tavern-btn" data-i18n="generate">Generate</button>
              <div class="result tavern-result"></div>
            </div>

            <!-- Plot Hooks -->
            <div class="generator-card">
              <h3 data-i18n="plotHooks">Plot Hooks</h3>
              <button class="btn generate-plot-btn" data-i18n="generate">Generate</button>
              <div class="result plot-result"></div>
            </div>

            <!-- Treasure -->
            <div class="generator-card">
              <h3 data-i18n="treasure">Treasure</h3>
              <select id="treasure-type" class="input">
                <option value="minor" data-i18n="minor">Minor</option>
                <option value="moderate" data-i18n="moderate">Moderate</option>
                <option value="major" data-i18n="major">Major</option>
              </select>
              <button class="btn generate-treasure-btn" data-i18n="generate">Generate</button>
              <div class="result treasure-result"></div>
            </div>

            <!-- Random Encounters -->
            <div class="generator-card">
              <h3 data-i18n="randomEncounter">Random Encounter</h3>
              <select id="encounter-environment" class="input">
                <option value="forest" data-i18n="forest">Forest</option>
                <option value="dungeon" data-i18n="dungeon">Dungeon</option>
                <option value="city" data-i18n="city">City</option>
                <option value="mountain" data-i18n="mountain">Mountain</option>
                <option value="swamp" data-i18n="swamp">Swamp</option>
              </select>
              <button class="btn generate-encounter-btn" data-i18n="generate">Generate</button>
              <div class="result encounter-result"></div>
            </div>

            <!-- Rumors -->
            <div class="generator-card">
              <h3 data-i18n="tavernRumors">Tavern Rumors</h3>
              <button class="btn generate-rumor-btn" data-i18n="generate">Generate</button>
              <div class="result rumor-result"></div>
            </div>

            <!-- Magic Items -->
            <div class="generator-card">
              <h3 data-i18n="magicItem">Magic Item</h3>
              <select id="item-rarity" class="input">
                <option value="common" data-i18n="common">Common</option>
                <option value="uncommon" data-i18n="uncommon">Uncommon</option>
                <option value="rare" data-i18n="rare">Rare</option>
                <option value="very-rare" data-i18n="veryRare">Very Rare</option>
              </select>
              <button class="btn generate-magic-btn" data-i18n="generate">Generate</button>
              <div class="result magic-result"></div>
            </div>

            <!-- Weather -->
            <div class="generator-card">
              <h3 data-i18n="weather">Weather</h3>
              <button class="btn generate-weather-btn" data-i18n="generate">Generate</button>
              <div class="result weather-result"></div>
            </div>
          </div>

          <!-- Dice Roller -->
          <div class="dice-roller">
            <h3 data-i18n="diceRoller">Dice Roller</h3>
            <div class="dice-buttons">
              <button class="btn-dice" data-die="d4">d4</button>
              <button class="btn-dice" data-die="d6">d6</button>
              <button class="btn-dice" data-die="d8">d8</button>
              <button class="btn-dice" data-die="d10">d10</button>
              <button class="btn-dice" data-die="d12">d12</button>
              <button class="btn-dice" data-die="d20">d20</button>
              <button class="btn-dice" data-die="d100">d100</button>
            </div>
            <div class="dice-custom">
              <label for="custom-dice"><strong data-i18n="customDicePlaceholder">Custom Dice (e.g., 2d6+3 or
                  2t6+3)</strong></label>
              <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                <input id="custom-dice" type="text" placeholder="2d6+3" class="input">
                <button id="roll-custom-dice-btn" class="btn" data-i18n="roll">Roll</button>
              </div>
            </div>
            <div id="dice-result" class="dice-result" style="display: none;">
              <strong id="dice-result-text"></strong>
            </div>
          </div>
        </div>
      </div>

      <!-- Note Taker Tab -->
      <div id="tab-notes" class="tab-pane">
        <div class="note-taker">
          <div class="notes-header">
            <h2>üìù <span data-i18n="sessionNotes">Session Notes</span></h2>
            <button id="new-session-btn" class="btn" data-i18n="newSession">+ New Session</button>
          </div>

          <!-- Sessions Sidebar -->
          <div id="sessions-sidebar" class="sessions-sidebar">
            <!-- Sessions will be rendered here -->
          </div>

          <div id="no-sessions" class="empty-state" style="display: none;">
            <p data-i18n="noSessions">No sessions created yet</p>
          </div>

          <!-- Note Editor -->
          <div id="note-editor" class="note-editor" style="display: none;">
            <div class="editor-header">
              <h3 id="current-session-title"></h3>
              <span id="save-status" class="auto-save"></span>
            </div>

            <div class="editor-toolbar">
              <button class="btn-small add-section-btn" data-section="events" data-i18n="events">+ Events</button>
              <button class="btn-small add-section-btn" data-section="npcsMet" data-i18n="npcsMet">+ NPCs Met</button>
              <button class="btn-small add-section-btn" data-section="locations" data-i18n="locations">+
                Locations</button>
              <button class="btn-small add-section-btn" data-section="quests" data-i18n="quests">+ Quests</button>
              <button class="btn-small add-section-btn" data-section="loot" data-i18n="loot">+ Loot</button>
              <button class="btn-small add-section-btn" data-section="notes" data-i18n="notes">+ Notes</button>
            </div>

            <div id="sections-container" class="sections">
              <!-- Sections will be rendered here -->
            </div>

            <!-- Quick Notes -->
            <div class="quick-notes">
              <h4 data-i18n="quickNotes">Quick Notes</h4>
              <div id="quick-notes-list" class="quick-notes-list">
                <!-- Quick notes will be rendered here -->
              </div>
              <div class="quick-note-input">
                <label for="quick-note-text" data-i18n="quickNotePlaceholder">Quick Note</label>
                <div style="display: flex; gap: 0.5rem;">
                  <input id="quick-note-text" type="text" placeholder="" class="input">
                  <button id="add-quick-note-btn" class="btn-small" data-i18n="add">Add</button>
                </div>
              </div>
            </div>
          </div>

          <div id="no-session-selected" class="no-session-selected">
            <p data-i18n="selectSession">Select a session to view notes</p>
          </div>
        </div>

        <!-- New Session Modal -->
        <div id="new-session-modal" class="modal-overlay" style="display: none;">
          <div class="modal">
            <h3 data-i18n="newSession">New Session</h3>
            <input id="new-session-title" type="text" data-i18n-placeholder="sessionTitle" placeholder="Session Title"
              class="input">
            <div class="modal-actions">
              <button id="create-session-btn" class="btn" data-i18n="create">Create</button>
              <button id="cancel-session-btn" class="btn btn-secondary" data-i18n="cancel">Cancel</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="ads.js"></script>
  <script src="storage-utils.js"></script>
  <script type="module" src="auth.js"></script>
  <script type="module" src="translations.js"></script>
  <script type="module" src="campaign-manager.ts"></script>
  <script src="random-data.js"></script>
  <script>
    // Wait for modules to load
    window.addEventListener('load', () => {
      // Require authentication
      if (typeof requireAuth === 'function' && !requireAuth()) {
        throw new Error('Authentication required');
      }
    });

    // ========================================
    // EMBEDDED API KEY
    // ========================================
    const GEMINI_API_KEY = 'AIzaSyC_FPJb1pVXl4x8_cWd8xX9T-c1z238wiI';

    // ========================================
    // GLOBAL STATE & I18N
    // ========================================
    let currentLanguage = localStorage.getItem('language') || 'en';

    function t(key) {
      return translations[currentLanguage]?.[key] || key;
    }

    function updateTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });

      document.querySelectorAll('option[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      // ========================================
      // TAB NAVIGATION
      // ========================================
      function switchTab(tabId) {
        document.querySelectorAll('.tab-button').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

        document.querySelectorAll('.tab-pane').forEach(pane => {
          pane.classList.remove('active');
        });
        document.getElementById(`tab-${tabId}`).classList.add('active');
      }

    // ========================================
    // INITIATIVE TRACKER
    // ========================================
    // Handled by initiative-tracker.js module


    // Continue in next script tag...
  </script>

  <script>
      // Wait for modules to load
      window.addEventListener('load', () => {
        // ========================================
        // ENCOUNTER BUILDER
        // ========================================
        let encounters = [];
        let editingEncounterId = null;

        function loadEncounters() {
          const saved = localStorage.getItem('encounters');
          if (saved) encounters = JSON.parse(saved);
        }

        function saveEncounters() {
          localStorage.setItem('encounters', JSON.stringify(encounters));
        }

        function renderEncounters() {
          const list = document.getElementById('encounters-list');
          const noEncounters = document.getElementById('no-encounters');

          if (encounters.length === 0) {
            list.innerHTML = '';
            noEncounters.style.display = 'block';
            return;
          }

          noEncounters.style.display = 'none';

          list.innerHTML = encounters.map(encounter => {
            const totalCR = encounter.creatures.reduce((sum, c) => sum + (c.cr || 0), 0).toFixed(2);
            const isEditing = editingEncounterId === encounter.id;

            return `
          <div class="encounter-card">
            <div class="encounter-info">
              <h3>${encounter.name}</h3>
              ${encounter.description ? `<p class="description">${encounter.description}</p>` : ''}
              <div class="encounter-stats">
                <span>${t('creatures')}: ${encounter.creatures.length}</span>
                ${encounter.creatures.length > 0 ? `<span>${t('totalCR')}: ${totalCR}</span>` : ''}
              </div>
            </div>

            <div class="encounter-actions">
              <button class="btn-small edit-encounter" data-id="${encounter.id}">${t('edit')}</button>
              <button class="btn-small load-encounter" data-id="${encounter.id}">${t('loadToInitiative')}</button>
              <button class="btn-small btn-danger delete-encounter" data-id="${encounter.id}">${t('delete')}</button>
            </div>

            ${encounter.creatures.length > 0 ? `
              <div class="creatures-list">
                ${encounter.creatures.map((creature, index) => `
                  <div class="creature-item">
                    <div class="creature-info">
                      <span class="creature-name">${creature.name}</span>
                      <span class="creature-stat">${t('hp')}: ${creature.hp}</span>
                      <span class="creature-stat">${t('ac')}: ${creature.ac}</span>
                      <span class="creature-stat">${t('cr')}: ${creature.cr || 0}</span>
                    </div>
                    <button class="btn-tiny remove-creature" data-encounter-id="${encounter.id}" data-index="${index}">${t('remove')}</button>
                  </div>
                `).join('')}
              </div>
            ` : ''}

            ${isEditing ? `
              <div class="add-creature-form">
                <input type="text" class="input creature-name-input" placeholder="${t('creatureName')}" data-encounter-id="${encounter.id}">
                <input type="number" class="input short creature-hp-input" placeholder="${t('hp')}" value="10" data-encounter-id="${encounter.id}">
                <input type="number" class="input short creature-ac-input" placeholder="${t('ac')}" value="10" data-encounter-id="${encounter.id}">
                <input type="number" class="input short creature-cr-input" placeholder="${t('cr')}" value="0" step="0.125" data-encounter-id="${encounter.id}">
                <input type="number" class="input short creature-count-input" placeholder="${t('count')}" value="1" min="1" data-encounter-id="${encounter.id}">
                <button class="btn-small add-creature-to-encounter" data-encounter-id="${encounter.id}">${t('add')}</button>
              </div>
            ` : ''}
          </div>
        `;
          }).join('');

          document.querySelectorAll('.edit-encounter').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = parseInt(e.target.dataset.id);
              editingEncounterId = editingEncounterId === id ? null : id;
              renderEncounters();
            });
          });

          document.querySelectorAll('.delete-encounter').forEach(btn => {
            btn.addEventListener('click', (e) => {
              if (confirm(t('deleteEncounterConfirm'))) {
                const id = parseInt(e.target.dataset.id);
                encounters = encounters.filter(enc => enc.id !== id);
                saveEncounters();
                renderEncounters();
              }
            });
          });

          document.querySelectorAll('.load-encounter').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const id = parseInt(e.target.dataset.id);
              const encounter = encounters.find(enc => enc.id === id);
              if (encounter) {
                if (window.initiativeTracker) {
                  encounter.creatures.forEach(creature => {
                    const count = creature.count || 1;
                    for (let i = 0; i < count; i++) {
                      window.initiativeTracker.addCombatant({
                        name: count > 1 ? `${creature.name} ${i + 1}` : creature.name,
                        initiative: 10,
                        hp: creature.hp,
                        ac: creature.ac,
                        cr: creature.cr || 0
                      });
                    }
                  });

                  const totalCreatures = encounter.creatures.reduce((sum, c) => sum + (c.count || 1), 0);
                  alert(`${totalCreatures} ${t('creaturesLoaded')}`);
                  switchTab('initiative');
                  if (window.initiativeTracker.renderUI) window.initiativeTracker.renderUI();
                } else {
                  console.error("Initiative Tracker not initialized");
                }
              }
            });
          });

          document.querySelectorAll('.remove-creature').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const encounterId = parseInt(e.target.dataset.encounterId);
              const index = parseInt(e.target.dataset.index);
              const encounter = encounters.find(enc => enc.id === encounterId);
              if (encounter) {
                encounter.creatures.splice(index, 1);
                saveEncounters();
                renderEncounters();
              }
            });
          });

          document.querySelectorAll('.add-creature-to-encounter').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const encounterId = parseInt(e.target.dataset.encounterId);
              const encounter = encounters.find(enc => enc.id === encounterId);

              const nameInput = document.querySelector(`.creature-name-input[data-encounter-id="${encounterId}"]`);
              const hpInput = document.querySelector(`.creature-hp-input[data-encounter-id="${encounterId}"]`);
              const acInput = document.querySelector(`.creature-ac-input[data-encounter-id="${encounterId}"]`);
              const crInput = document.querySelector(`.creature-cr-input[data-encounter-id="${encounterId}"]`);
              const countInput = document.querySelector(`.creature-count-input[data-encounter-id="${encounterId}"]`);

              const name = nameInput.value.trim();
              const hp = parseInt(hpInput.value) || 10;
              const ac = parseInt(acInput.value) || 10;
              const cr = parseFloat(crInput.value) || 0;
              const count = parseInt(countInput.value) || 1;

              if (name && encounter) {
                for (let i = 0; i < count; i++) {
                  const suffix = count > 1 ? ` ${i + 1}` : '';
                  encounter.creatures.push({ name: name + suffix, hp, ac, cr });
                }
                nameInput.value = '';
                saveEncounters();
                renderEncounters();
              }
            });
          });
        }

        function showNewEncounterModal() {
          document.getElementById('new-encounter-modal').style.display = 'flex';
        }

        function hideNewEncounterModal() {
          document.getElementById('new-encounter-modal').style.display = 'none';
          document.getElementById('new-encounter-name').value = '';
          document.getElementById('new-encounter-description').value = '';
        }

        function createEncounter() {
          const name = document.getElementById('new-encounter-name').value.trim();
          const description = document.getElementById('new-encounter-description').value.trim();

          if (name) {
            encounters.push({ id: Date.now(), name, description, creatures: [] });
            saveEncounters();
            renderEncounters();
            hideNewEncounterModal();
          }
        }

      // Continue in next script tag...
  </script>

  <script>
        // Wait for modules to load
        window.addEventListener('load', () => {
          // ========================================
          // MONSTER BROWSER (Open5e API + D&D Beyond Links)
          // ========================================
          let monsters = [];
          let selectedMonster = null;

          async function searchMonsters() {
            const searchTerm = document.getElementById('monster-search-input').value.trim();
            const loadingEl = document.getElementById('monsters-loading');
            const listEl = document.getElementById('monsters-list');
            const noMonstersEl = document.getElementById('no-monsters');

            loadingEl.style.display = 'block';
            listEl.innerHTML = '';
            noMonstersEl.style.display = 'none';

            try {
              const url = searchTerm
                ? `https://api.open5e.com/monsters/?search=${encodeURIComponent(searchTerm)}`
                : 'https://api.open5e.com/monsters/?limit=20';

              const response = await fetch(url);
              const data = await response.json();
              monsters = data.results;

              loadingEl.style.display = 'none';

              if (monsters.length === 0) {
                noMonstersEl.style.display = 'block';
                return;
              }

              renderMonsters();

            } catch (error) {
              loadingEl.style.display = 'none';
              listEl.innerHTML = `<p class="error-message">Error loading monsters: ${error.message}</p>`;
            }
          }

          function renderMonsters() {
            const listEl = document.getElementById('monsters-list');

            listEl.innerHTML = monsters.map(monster => {
              const dndBeyondSlug = monster.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

              return `
          <div class="monster-card" data-slug="${monster.slug}">
            <h3>${monster.name}</h3>
            <p><em>${monster.size} ${monster.type}, ${monster.alignment}</em></p>
            <div class="monster-stats">
              <span class="monster-stat"><strong>CR:</strong> ${monster.challenge_rating}</span>
              <span class="monster-stat"><strong>HP:</strong> ${monster.hit_points}</span>
              <span class="monster-stat"><strong>AC:</strong> ${monster.armor_class}</span>
            </div>
            <div class="monster-links">
              <a href="https://www.dndbeyond.com/monsters/${dndBeyondSlug}" target="_blank" class="monster-link" onclick="event.stopPropagation()">
                üìñ D&D Beyond
              </a>
              <a href="https://open5e.com/monsters/${monster.slug}" target="_blank" class="monster-link" onclick="event.stopPropagation()">
                üìö Open5e
              </a>
            </div>
          </div>
        `;
            }).join('');

            // Add click handlers
            document.querySelectorAll('.monster-card').forEach(card => {
              card.addEventListener('click', () => {
                const slug = card.dataset.slug;
                const monster = monsters.find(m => m.slug === slug);
                if (monster) showMonsterDetails(monster);
              });
            });
          }

          function showMonsterDetails(monster) {
            selectedMonster = monster;
            const content = document.getElementById('monster-details-content');
            const dndBeyondSlug = monster.name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');

            content.innerHTML = `
        <h2>${monster.name}</h2>
        <p><em>${monster.size} ${monster.type}, ${monster.alignment}</em></p>

        <hr style="margin: 1rem 0; border-color: var(--wood-brown);">

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
          <div><strong>AC:</strong> ${monster.armor_class} ${monster.armor_desc || ''}</div>
          <div><strong>HP:</strong> ${monster.hit_points} (${monster.hit_dice})</div>
          <div><strong>Speed:</strong> ${JSON.stringify(monster.speed).replace(/[{}",]/g, ' ')}</div>
        </div>

        <hr style="margin: 1rem 0; border-color: var(--wood-brown);">

        <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.5rem; text-align: center; margin-bottom: 1rem;">
          <div><strong>STR</strong><br>${monster.strength} (${Math.floor((monster.strength - 10) / 2)})</div>
          <div><strong>DEX</strong><br>${monster.dexterity} (${Math.floor((monster.dexterity - 10) / 2)})</div>
          <div><strong>CON</strong><br>${monster.constitution} (${Math.floor((monster.constitution - 10) / 2)})</div>
          <div><strong>INT</strong><br>${monster.intelligence} (${Math.floor((monster.intelligence - 10) / 2)})</div>
          <div><strong>WIS</strong><br>${monster.wisdom} (${Math.floor((monster.wisdom - 10) / 2)})</div>
          <div><strong>CHA</strong><br>${monster.charisma} (${Math.floor((monster.charisma - 10) / 2)})</div>
        </div>

        <hr style="margin: 1rem 0; border-color: var(--wood-brown);">

        ${monster.damage_vulnerabilities ? `<p><strong>Damage Vulnerabilities:</strong> ${monster.damage_vulnerabilities}</p>` : ''}
        ${monster.damage_resistances ? `<p><strong>Damage Resistances:</strong> ${monster.damage_resistances}</p>` : ''}
        ${monster.damage_immunities ? `<p><strong>Damage Immunities:</strong> ${monster.damage_immunities}</p>` : ''}
        ${monster.condition_immunities ? `<p><strong>Condition Immunities:</strong> ${monster.condition_immunities}</p>` : ''}
        ${monster.senses ? `<p><strong>Senses:</strong> ${monster.senses}</p>` : ''}
        ${monster.languages ? `<p><strong>Languages:</strong> ${monster.languages}</p>` : ''}
        <p><strong>Challenge:</strong> ${monster.challenge_rating} (${monster.xp || 0} XP)</p>

        <hr style="margin: 1rem 0; border-color: var(--wood-brown);">

        ${monster.special_abilities && monster.special_abilities.length > 0 ? `
          <h3>Special Abilities</h3>
          ${monster.special_abilities.map(ability => `
            <p><strong>${ability.name}.</strong> ${ability.desc}</p>
          `).join('')}
        ` : ''}

        ${monster.actions && monster.actions.length > 0 ? `
          <h3>Actions</h3>
          ${monster.actions.map(action => `
            <p><strong>${action.name}.</strong> ${action.desc}</p>
          `).join('')}
        ` : ''}

        ${monster.legendary_actions && monster.legendary_actions.length > 0 ? `
          <h3>Legendary Actions</h3>
          ${monster.legendary_actions.map(action => `
            <p><strong>${action.name}.</strong> ${action.desc}</p>
          `).join('')}
        ` : ''}

        <hr style="margin: 1rem 0; border-color: var(--wood-brown);">

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <a href="https://www.dndbeyond.com/monsters/${dndBeyondSlug}" target="_blank" class="monster-link">
            üìñ View on D&D Beyond
          </a>
          <a href="https://open5e.com/monsters/${monster.slug}" target="_blank" class="monster-link">
            üìö View on Open5e
          </a>
        </div>
      `;

            document.getElementById('monster-details-modal').style.display = 'flex';
          }

          function addMonsterToEncounter() {
            if (!selectedMonster) return;

            // Check if there's an active encounter being edited in Encounters tab
            if (encounters.length === 0) {
              alert('Please create an encounter first in the Encounters tab!');
              return;
            }

            // Add to the most recent encounter (or you could add UI to select which encounter)
            const encounter = encounters[0];

            encounter.creatures.push({
              name: selectedMonster.name,
              hp: selectedMonster.hit_points,
              ac: selectedMonster.armor_class,
              cr: parseFloat(selectedMonster.challenge_rating) || 0
            });

            saveEncounters();
            alert(`${selectedMonster.name} added to "${encounter.name}"!`);
            document.getElementById('monster-details-modal').style.display = 'none';
          }

        // Continue in next script tag...
  </script>

  <script>
          // Wait for modules to load
          window.addEventListener('load', () => {
            // ========================================
            // NPC GENERATOR
            // ========================================
            let savedNPCs = [];
            let generatedNPC = null;

            function loadSavedNPCs() {
              const saved = localStorage.getItem('saved_npcs');
              if (saved) savedNPCs = JSON.parse(saved);
            }

            function saveSavedNPCs() {
              localStorage.setItem('saved_npcs', JSON.stringify(savedNPCs));
            }

            function renderSavedNPCs() {
              const section = document.getElementById('saved-npcs-section');
              const grid = document.getElementById('saved-npcs-grid');

              if (savedNPCs.length === 0) {
                section.style.display = 'none';
                return;
              }

              section.style.display = 'block';

              grid.innerHTML = savedNPCs.map(npc => `
        <div class="npc-card" data-id="${npc.id}">
          <div class="npc-card-header">
            <h4>${npc.name}</h4>
            <button class="btn-tiny btn-danger delete-npc" data-id="${npc.id}">${t('delete')}</button>
          </div>
          <p class="npc-preview">${npc.preview}</p>
        </div>
      `).join('');

              document.querySelectorAll('.npc-card').forEach(card => {
                card.addEventListener('click', (e) => {
                  if (!e.target.classList.contains('delete-npc')) {
                    const id = parseInt(card.dataset.id);
                    const npc = savedNPCs.find(n => n.id === id);
                    if (npc) viewNPC(npc);
                  }
                });
              });

              document.querySelectorAll('.delete-npc').forEach(btn => {
                btn.addEventListener('click', (e) => {
                  e.stopPropagation();
                  if (confirm(t('deleteNPCConfirm'))) {
                    const id = parseInt(e.target.dataset.id);
                    savedNPCs = savedNPCs.filter(n => n.id !== id);
                    saveSavedNPCs();
                    renderSavedNPCs();
                  }
                });
              });
            }

            function viewNPC(npc) {
              document.getElementById('viewing-npc-name').textContent = npc.name;
              document.getElementById('viewing-npc-content').innerHTML = formatNPC(npc.content);
              document.getElementById('view-npc-modal').style.display = 'flex';
            }

            function formatNPC(content) {
              return content
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
            }

            async function generateNPC() {
              const npcPrompt = document.getElementById('npc-prompt').value.trim();
              const npcRace = document.getElementById('npc-race').value;
              const setting = document.getElementById('npc-setting').value.trim();

              const generateBtn = document.getElementById('generate-npc-btn');
              generateBtn.disabled = true;
              generateBtn.textContent = t('generating');

              const prompt = `Generate a detailed D&D 5e NPC with the following specifications:
${npcPrompt ? `Role/Type: ${npcPrompt}` : ''}
${npcRace ? `Race: ${npcRace}` : ''}
${setting ? `Setting: ${setting}` : ''}

Please provide:
1. Name
2. Physical appearance
3. Personality traits and mannerisms
4. Background/backstory (brief)
5. Motivation/goals
6. A memorable quirk or secret
7. Key stats (HP, AC, notable abilities if combat-relevant)
8. Potential plot hooks for the DM

Format as clear sections. Be creative and specific!`;

              try {
                const response = await fetch(
                  `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`,
                  {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      contents: [{ parts: [{ text: prompt }] }]
                    })
                  }
                );

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const data = await response.json();
                const content = data.candidates[0].content.parts[0].text;
                const nameMatch = content.match(/(?:Name|NPC Name):\s*\*?\*?([^\n*]+)\*?\*?/i);
                const name = nameMatch ? nameMatch[1].trim() : 'Generated NPC';

                generatedNPC = { name, content, timestamp: Date.now() };

                document.getElementById('generated-npc-name').textContent = name;
                document.getElementById('generated-npc-content').innerHTML = formatNPC(content);
                document.getElementById('generated-npc-display').style.display = 'block';
                document.getElementById('npc-error').style.display = 'none';

              } catch (err) {
                document.getElementById('npc-error').textContent = `${t('generateError')} ${err.message}`;
                document.getElementById('npc-error').style.display = 'block';
              } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = t('generateNPC');
              }
            }

            function saveGeneratedNPC() {
              if (generatedNPC) {
                const preview = generatedNPC.content.substring(0, 100).replace(/[*#]/g, '');
                savedNPCs.unshift({
                  id: Date.now(),
                  name: generatedNPC.name,
                  content: generatedNPC.content,
                  preview,
                  timestamp: generatedNPC.timestamp
                });
                saveSavedNPCs();
                renderSavedNPCs();
                alert(t('npcSaved'));
              }
            }

          // Continue in next script tag...
  </script>

  <script>
            // Wait for modules to load
            window.addEventListener('load', () => {
              // ========================================
              // RANDOM TABLES
              // ========================================
              function roll(num, sides) {
                let total = 0;
                for (let i = 0; i < num; i++) {
                  total += Math.floor(Math.random() * sides) + 1;
                }
                return total;
              }

              function randomFrom(array) {
                return array[Math.floor(Math.random() * array.length)];
              }

              function generateName() {
                const nameType = document.getElementById('name-type').value;
                const type = names[currentLanguage][nameType];
                const first = randomFrom(type.first);
                const last = randomFrom(type.last);
                document.querySelector('.name-result').textContent = `${first} ${last}`;
              }

              function generateTavern() {
                const tavernType = document.getElementById('tavern-type').value;
                const options = tavernNames[currentLanguage][tavernType];
                document.querySelector('.tavern-result').textContent = randomFrom(options);
              }

              function generatePlotHook() {
                const hooks = plotHooks[currentLanguage];
                document.querySelector('.plot-result').textContent = randomFrom(hooks);
              }

              function generateTreasure() {
                const treasureType = document.getElementById('treasure-type').value;

                let treasure = '';
                if (currentLanguage === 'da') {
                  if (treasureType === 'minor') {
                    treasure = `${roll(2, 6) * 10} GP<br>${roll(1, 4)} √Üdelsten (10 GP hver)`;
                  } else if (treasureType === 'moderate') {
                    treasure = `${roll(4, 6) * 100} GP<br>${roll(2, 6)} √Üdelsten (50 GP hver)<br>1 Kunstgenstand (250 GP)<br>Rul p√• Magisk Genstand Tabel B`;
                  } else {
                    treasure = `${roll(1, 8) * 1000} GP<br>${roll(3, 6)} √Üdelsten (500 GP hver)<br>${roll(1, 4)} Kunstgenstande (2500 GP hver)<br>Rul p√• Magisk Genstand Tabel F`;
                  }
                } else {
                  if (treasureType === 'minor') {
                    treasure = `${roll(2, 6) * 10} GP<br>${roll(1, 4)} Gems (10 GP each)`;
                  } else if (treasureType === 'moderate') {
                    treasure = `${roll(4, 6) * 100} GP<br>${roll(2, 6)} Gems (50 GP each)<br>1 Art Object (250 GP)<br>Roll on Magic Item Table B`;
                  } else {
                    treasure = `${roll(1, 8) * 1000} GP<br>${roll(3, 6)} Gems (500 GP each)<br>${roll(1, 4)} Art Objects (2500 GP each)<br>Roll on Magic Item Table F`;
                  }
                }

                document.querySelector('.treasure-result').innerHTML = treasure;
              }

              function generateEncounter() {
                const environment = document.getElementById('encounter-environment').value;
                const options = encounters[currentLanguage][environment];
                document.querySelector('.encounter-result').textContent = randomFrom(options);
              }

              function generateRumor() {
                const rumorList = rumors[currentLanguage];
                document.querySelector('.rumor-result').textContent = randomFrom(rumorList);
              }

              function generateMagicItem() {
                const rarity = document.getElementById('item-rarity').value;
                const options = magicItems[currentLanguage][rarity];
                document.querySelector('.magic-result').textContent = randomFrom(options);
              }

              function generateWeather() {
                const weatherList = weather[currentLanguage];
                document.querySelector('.weather-result').textContent = randomFrom(weatherList);
              }

              function rollDice(die) {
                const sides = parseInt(die.substring(1));
                const result = roll(1, sides);
                document.getElementById('dice-result-text').textContent = `${die}: ${result}`;
                document.getElementById('dice-result').style.display = 'block';
              }

              function rollCustomDice() {
                const customDice = document.getElementById('custom-dice').value.trim();
                try {
                  const match = customDice.match(/(\d+)[dt](\d+)([+-]\d+)?/);
                  if (match) {
                    const num = parseInt(match[1]);
                    const sides = parseInt(match[2]);
                    const modifier = match[3] ? parseInt(match[3]) : 0;
                    const result = roll(num, sides) + modifier;
                    document.getElementById('dice-result-text').textContent = `${customDice}: ${result}`;
                    document.getElementById('dice-result').style.display = 'block';
                  } else {
                    document.getElementById('dice-result-text').textContent = t('invalidDiceFormat');
                    document.getElementById('dice-result').style.display = 'block';
                  }
                } catch (e) {
                  document.getElementById('dice-result-text').textContent = t('diceRollError');
                  document.getElementById('dice-result').style.display = 'block';
                }
              }

            // Continue in next script tag...
  </script>

  <script>
              // Wait for modules to load
              window.addEventListener('load', () => {
                // ========================================
                // NOTE TAKER
                // ========================================
                let sessions = [];
                let currentSession = null;
                let saveTimeout = null;

                function loadSessions() {
                  const saved = localStorage.getItem('session_notes');
                  if (saved) sessions = JSON.parse(saved);
                }

                function saveSessions() {
                  localStorage.setItem('session_notes', JSON.stringify(sessions));
                  document.getElementById('save-status').textContent = t('allChangesSaved');
                }

                function autoSave() {
                  document.getElementById('save-status').textContent = t('saving');
                  clearTimeout(saveTimeout);
                  saveTimeout = setTimeout(() => saveSessions(), 1000);
                }

                function renderSessions() {
                  const sidebar = document.getElementById('sessions-sidebar');
                  const noSessions = document.getElementById('no-sessions');

                  if (sessions.length === 0) {
                    sidebar.innerHTML = '';
                    noSessions.style.display = 'block';
                    return;
                  }

                  noSessions.style.display = 'none';

                  sidebar.innerHTML = sessions.map(session => {
                    const date = new Date(session.date);
                    const formattedDate = date.toLocaleDateString('en-US', {
                      month: 'short',
                      day: 'numeric',
                      year: 'numeric',
                      hour: '2-digit',
                      minute: '2-digit'
                    });

                    return `
          <div class="session-item ${currentSession && currentSession.id === session.id ? 'active' : ''}" data-id="${session.id}">
            <div class="session-info">
              <h4>${session.title}</h4>
              <span class="session-date">${formattedDate}</span>
            </div>
            <button class="btn-tiny btn-danger delete-session" data-id="${session.id}">√ó</button>
          </div>
        `;
                  }).join('');

                  document.querySelectorAll('.session-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                      if (!e.target.classList.contains('delete-session')) {
                        const id = parseInt(item.dataset.id);
                        const session = sessions.find(s => s.id === id);
                        if (session) selectSession(session);
                      }
                    });
                  });

                  document.querySelectorAll('.delete-session').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                      e.stopPropagation();
                      if (confirm(t('deleteSessionConfirm'))) {
                        const id = parseInt(e.target.dataset.id);
                        sessions = sessions.filter(s => s.id !== id);
                        if (currentSession && currentSession.id === id) {
                          currentSession = null;
                          document.getElementById('note-editor').style.display = 'none';
                          document.getElementById('no-session-selected').style.display = 'block';
                        }
                        saveSessions();
                        renderSessions();
                      }
                    });
                  });
                }

                function selectSession(session) {
                  currentSession = session;
                  document.getElementById('note-editor').style.display = 'block';
                  document.getElementById('no-session-selected').style.display = 'none';
                  document.getElementById('current-session-title').textContent = session.title;
                  document.getElementById('save-status').textContent = t('allChangesSaved');
                  renderSections();
                  renderQuickNotes();
                  renderSessions();
                }

                function renderSections() {
                  if (!currentSession) return;

                  const container = document.getElementById('sections-container');
                  container.innerHTML = currentSession.sections.map((section, index) => `
        <div class="section">
          <div class="section-header">
            <input type="text" class="section-title-input" value="${section.title}" data-index="${index}">
            <button class="btn-tiny remove-section-btn" data-index="${index}">${t('remove')}</button>
          </div>
          <textarea class="section-textarea" data-index="${index}" rows="6" placeholder="Enter ${section.title.toLowerCase()} here...">${section.content}</textarea>
        </div>
      `).join('');

                  container.querySelectorAll('.section-title-input').forEach(input => {
                    input.addEventListener('input', (e) => {
                      const index = parseInt(e.target.dataset.index);
                      currentSession.sections[index].title = e.target.value;
                      autoSave();
                    });
                  });

                  container.querySelectorAll('.section-textarea').forEach(textarea => {
                    textarea.addEventListener('input', (e) => {
                      const index = parseInt(e.target.dataset.index);
                      currentSession.sections[index].content = e.target.value;
                      autoSave();
                    });
                  });

                  container.querySelectorAll('.remove-section-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                      const index = parseInt(e.target.dataset.index);
                      currentSession.sections.splice(index, 1);
                      autoSave();
                      renderSections();
                    });
                  });
                }

                function renderQuickNotes() {
                  if (!currentSession) return;

                  const list = document.getElementById('quick-notes-list');
                  list.innerHTML = currentSession.quickNotes.map((note, index) => `
        <div class="quick-note">
          <span>${note.timestamp} - ${note.text}</span>
          <button class="btn-tiny remove-quick-note" data-index="${index}">√ó</button>
        </div>
      `).join('');

                  list.querySelectorAll('.remove-quick-note').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                      const index = parseInt(e.target.dataset.index);
                      currentSession.quickNotes.splice(index, 1);
                      autoSave();
                      renderQuickNotes();
                    });
                  });
                }

                function addSection(title) {
                  if (currentSession) {
                    currentSession.sections.push({ title, content: '' });
                    autoSave();
                    renderSections();
                  }
                }

                function addQuickNote() {
                  const input = document.getElementById('quick-note-text');
                  const text = input.value.trim();

                  if (text && currentSession) {
                    const timestamp = new Date().toLocaleTimeString('en-US', {
                      hour: '2-digit',
                      minute: '2-digit'
                    });
                    currentSession.quickNotes.push({ timestamp, text });
                    input.value = '';
                    autoSave();
                    renderQuickNotes();
                  }
                }

                function showNewSessionModal() {
                  document.getElementById('new-session-modal').style.display = 'flex';
                }

                function hideNewSessionModal() {
                  document.getElementById('new-session-modal').style.display = 'none';
                  document.getElementById('new-session-title').value = '';
                }

                function createSession() {
                  const title = document.getElementById('new-session-title').value.trim();

                  if (title) {
                    const newSession = {
                      id: Date.now(),
                      title,
                      date: new Date().toISOString(),
                      sections: [
                        { title: t('sessionSummary'), content: '' },
                        { title: t('events'), content: '' },
                        { title: t('npcsMet'), content: '' },
                        { title: t('quests'), content: '' }
                      ],
                      quickNotes: []
                    };

                    sessions.unshift(newSession);
                    currentSession = newSession;
                    saveSessions();
                    renderSessions();
                    selectSession(newSession);
                    hideNewSessionModal();
                  }
                }

                // ========================================
                // INITIALIZATION
                // ========================================
                document.addEventListener('DOMContentLoaded', () => {
                  // Language selector
                  const languageSelector = document.getElementById('language');
                  languageSelector.value = currentLanguage;
                  languageSelector.addEventListener('change', (e) => {
                    currentLanguage = e.target.value;
                    localStorage.setItem('language', currentLanguage);
                    updateTranslations();
                  });

                  // Tab navigation
                  document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', () => switchTab(btn.dataset.tab));
                  });

                  // Modal close on overlay click
                  document.querySelectorAll('.modal-overlay').forEach(overlay => {
                    overlay.addEventListener('click', (e) => {
                      if (e.target === overlay) overlay.style.display = 'none';
                    });
                  });

                  // Initiative Tracker
                  document.getElementById('add-combatant-btn').addEventListener('click', addCombatant);
                  document.getElementById('combatant-name').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') addCombatant();
                  });
                  document.getElementById('next-turn-btn').addEventListener('click', nextTurn);
                  document.getElementById('reset-combat-btn').addEventListener('click', resetCombat);

                  // Encounter Builder
                  document.getElementById('new-encounter-btn').addEventListener('click', showNewEncounterModal);
                  document.getElementById('cancel-encounter-btn').addEventListener('click', hideNewEncounterModal);
                  document.getElementById('create-encounter-btn').addEventListener('click', createEncounter);
                  document.getElementById('new-encounter-name').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') createEncounter();
                  });

                  // NPC Generator
                  document.getElementById('generate-npc-btn').addEventListener('click', generateNPC);
                  document.getElementById('save-npc-btn').addEventListener('click', saveGeneratedNPC);
                  document.getElementById('close-npc-modal-btn').addEventListener('click', () => {
                    document.getElementById('view-npc-modal').style.display = 'none';
                  });

                  // Random Tables
                  document.querySelector('.generate-name-btn').addEventListener('click', generateName);
                  document.querySelector('.generate-tavern-btn').addEventListener('click', generateTavern);
                  document.querySelector('.generate-plot-btn').addEventListener('click', generatePlotHook);
                  document.querySelector('.generate-treasure-btn').addEventListener('click', generateTreasure);
                  document.querySelector('.generate-encounter-btn').addEventListener('click', generateEncounter);
                  document.querySelector('.generate-rumor-btn').addEventListener('click', generateRumor);
                  document.querySelector('.generate-magic-btn').addEventListener('click', generateMagicItem);
                  document.querySelector('.generate-weather-btn').addEventListener('click', generateWeather);

                  document.querySelectorAll('.btn-dice').forEach(btn => {
                    btn.addEventListener('click', () => rollDice(btn.dataset.die));
                  });

                  document.getElementById('roll-custom-dice-btn').addEventListener('click', rollCustomDice);
                  document.getElementById('custom-dice').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') rollCustomDice();
                  });

                  // Note Taker
                  document.getElementById('new-session-btn').addEventListener('click', showNewSessionModal);
                  document.getElementById('cancel-session-btn').addEventListener('click', hideNewSessionModal);
                  document.getElementById('create-session-btn').addEventListener('click', createSession);
                  document.getElementById('new-session-title').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') createSession();
                  });

                  document.querySelectorAll('.add-section-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                      const sectionName = t(btn.dataset.section);
                      addSection(sectionName);
                    });
                  });

                  document.getElementById('add-quick-note-btn').addEventListener('click', addQuickNote);
                  document.getElementById('quick-note-text').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') addQuickNote();
                  });

                  // Monster Browser
                  document.getElementById('search-monsters-btn').addEventListener('click', searchMonsters);
                  document.getElementById('monster-search-input').addEventListener('keyup', (e) => {
                    if (e.key === 'Enter') searchMonsters();
                  });
                  document.getElementById('close-monster-modal-btn').addEventListener('click', () => {
                    document.getElementById('monster-details-modal').style.display = 'none';
                  });
                  document.getElementById('add-monster-to-encounter-btn').addEventListener('click', addMonsterToEncounter);

                  // Load initial monsters when switching to monsters tab
                  document.querySelector('[data-tab="monsters"]').addEventListener('click', () => {
                    const listEl = document.getElementById('monsters-list');
                    if (listEl.children.length === 0 && monsters.length === 0) {
                      searchMonsters(); // Auto-load initial monsters
                    }
                  });

                  // Load data and render
                  // loadInitiativeData(); // Removed (handled by module)
                  loadEncounters();
                  loadSavedNPCs();
                  loadSessions();

                  updateTranslations();
                  // renderCombatants(); // Removed (handled by module)
                  renderEncounters();
                  renderSavedNPCs();
                  renderSessions();

                  if (sessions.length === 0) {
                    document.getElementById('no-session-selected').style.display = 'block';
                  } else {
                    document.getElementById('no-session-selected').style.display = 'none';
                  }
                });
  </script>
  <script type="module">
                import { InitiativeTracker } from './initiative-tracker.js';
                import { SessionManager } from './session-manager.js';

                // Initialize Tracker for DM Screen
                window.addEventListener('load', () => {
                  // Session Hosting
                  const campaignCode = localStorage.getItem('activeCampaignCode');
                  const campaignDisplay = document.getElementById('display-campaign-code');
                  if (campaignDisplay && campaignCode) campaignDisplay.textContent = campaignCode;

                  const livePlayers = new Map(); // Store player data: { id -> {name, hp, ac, ...} }

                  if (campaignCode) {
                    const session = new SessionManager('host', campaignCode);
                    session.connect();
                    window.sessionManager = session;

                    // Listen for players
                    session.onMessage((type, payload) => {
                      if (type === 'PLAYER_JOIN') {
                        console.log(`Player joined: ${payload.peerId}`);
                        // Request full update from new player? 
                        // For now, they will send CHARACTER_UPDATE on join automatically
                      }

                      if (type === 'CHARACTER_UPDATE') {
                        livePlayers.set(payload.id, payload);
                        renderLivePlayers();
                      }
                    });
                  }

                  function renderLivePlayers() {
                    const list = document.getElementById('live-party-list');
                    const empty = document.getElementById('no-players');

                    if (livePlayers.size === 0) {
                      if (list) list.innerHTML = '';
                      if (empty) empty.style.display = 'block';
                      return;
                    }

                    if (empty) empty.style.display = 'none';
                    if (list) {
                      list.innerHTML = Array.from(livePlayers.values()).map(p => `
                            <div class="encounter-item" style="display: flex; justify-content: space-between; align-items: center; border-left: 4px solid var(--primary-gold);">
                                <div>
                                    <h3>${p.name}</h3>
                                    <div style="font-size: 0.9em; opacity: 0.8;">
                                        Lvl ${p.level} ${p.class} | AC: <strong style="color: var(--accent-blue);">${p.ac}</strong>
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; font-size: 1.2em; color: ${p.hp.current < p.hp.max / 2 ? 'var(--love-red)' : 'var(--success)'};">
                                        HP: ${p.hp.current} <span style="font-size: 0.8em; opacity: 0.6;">/ ${p.hp.max}</span>
                                    </div>
                                    <button class="btn btn-tiny btn-secondary add-live-combatant" data-id="${p.id}">+ Initiative</button>
                                </div>
                            </div>
                          `).join('');

                      // Bind "Add to Initiative" buttons
                      list.querySelectorAll('.add-live-combatant').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                          const pid = parseInt(e.target.dataset.id);
                          const p = livePlayers.get(pid);
                          if (p) {
                            tracker.addCombatant({
                              name: p.name,
                              hp: p.hp.max, // Add with Max HP? Or Current? Usually start combat fresh or current
                              ac: p.ac,
                              initiative: Math.floor(Math.random() * 20) + 1 // Random init for now
                            });
                            alert(`${p.name} added to Initiative!`);
                            tracker.render(document.getElementById('combatants-list'));
                          }
                        });
                      });
                    }
                  }

                  const tracker = new InitiativeTracker({
                    containerId: 'combatants-list',
                    noCombatantsId: 'no-combatants'
                  });

                  // Expose for other scripts (like Encounter Builder)
                  window.initiativeTracker = tracker;

                  const listEl = document.getElementById('combatants-list');
                  const noCombatantsEl = document.getElementById('no-combatants');
                  const roundEl = document.getElementById('round-number');

                  function render() {
                    tracker.render(listEl);
                    if (roundEl) roundEl.textContent = tracker.state.round;

                    if (tracker.state.combatants.length === 0) {
                      if (noCombatantsEl) noCombatantsEl.style.display = 'block';
                    } else {
                      if (noCombatantsEl) noCombatantsEl.style.display = 'none';
                    }

                    // Listeners
                    listEl.querySelectorAll('.damage-btn, .heal-btn').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                        const id = parseFloat(e.target.dataset.id);
                        const amt = parseInt(e.target.dataset.amount);
                        tracker.adjustHP(id, amt);
                        render();
                      });
                    });

                    listEl.querySelectorAll('.remove-btn').forEach(btn => {
                      btn.addEventListener('click', (e) => {
                        const id = parseFloat(e.target.dataset.id);
                        tracker.removeCombatant(id);
                        render();
                      });
                    });
                  }

                  // Bind Controls
                  const addBtn = document.getElementById('add-combatant-btn');
                  if (addBtn) {
                    addBtn.addEventListener('click', () => {
                      const name = document.getElementById('combatant-name').value;
                      const init = document.getElementById('combatant-initiative').value;
                      const hp = document.getElementById('combatant-hp').value;
                      const ac = document.getElementById('combatant-ac').value;

                      if (name) {
                        tracker.addCombatant({ name, initiative: init, hp, ac });
                        // clear
                        document.getElementById('combatant-name').value = '';
                        render();
                      }
                    });
                  }

                  const nextBtn = document.getElementById('next-turn-btn');
                  if (nextBtn) nextBtn.addEventListener('click', () => { tracker.nextTurn(); render(); });

                  const resetBtn = document.getElementById('reset-combat-btn');
                  if (resetBtn) resetBtn.addEventListener('click', () => {
                    if (confirm('Reset?')) { tracker.resetCombat(); render(); }
                  });

                  // Hook into global render if needed or just polling
                  // Better: expose render method
                  window.initiativeTracker.renderUI = render;

                  // Initial Render
                  render();
                });
  </script>
</body>

</html>
```